<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>2911</id>
    <title>Pulling multiple images with shared layers simultaneously fails (v0.7.0)</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">Starting with a clean Linux 13.04 (raring) VM with kernel 3.8.0-33 and Docker 0.7.0.</sentence>
            <sentence id="1.2">1 Start a registry on port 8080: 'docker run -d -p 8080:5000 stackbrew/registry'</sentence>
            <sentence id="1.3">2 Create the following Dockerfile (note: the ADD is deliberately in an odd place):</sentence>
            <sentence id="1.9">1 Run this script (can take 15+ minutes):</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">This script emulates building 20 different services which share a lot of common layers.</sentence>
            <sentence id="2.2">1 Run the following script (this script can be run repeatedly):</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">Note that the 'docker run' has an '&amp;' on the end, so this script attempts to start all 20 service simultaneously, having first made sure that none of the images/layers are present locally.</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">Observe it failing in lots of different ways!</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">The failures can be more easily observed by running, say, terminator on Linux, starting 20 terminals and having them all linked and running the 'docker run' command separately (but simultaneously) in each terminal.</sentence>
            <sentence id="9.2">Make sure you're running 'bug-1' in one terminal, 'bug-2' in the next terminal, etc.</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">Failure modes we've seen:</sentence>
            <sentence id="10.2">1 'Error: start: No such container: &lt;containerId&gt;'</sentence>
            <sentence id="10.3">2 'Error pulling image (latest) from localhost:8080/demo/bug-X, Image &lt;imageId&gt; already exists'</sentence>
            <sentence id="10.4">3 'Server error: 404 trying to fetch remote history for demo/bug-X'</sentence>
        </paragraph>
    </description>
</bug>
