<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-3776</id>
    <title>ClassCastException when second level cache (ehcache) is activated with caches replication</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">I have an application with ehcache as second-level cache which is working fine.</sentence>
            <sentence id="1.2">Because we have another app that may access the database as well, we have started to activate the caches replication.</sentence>
            <sentence id="1.3">Since then, we see ClassCastException for basically any request that is issued on the system.</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">I've isolated two main cases</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">Case 1: ClassCastException in DefaultInitializeCollectionEventListener, line 129</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">CollectionCacheEntry cacheEntry = (CollectionCacheEntry) persister.getCacheEntryStructure()
						.</sentence>
            <sentence id="4.2">destructure(ce, factory);</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">the persister returns a UnstructuredCacheEntry instead of a CollectionCacheEntry.</sentence>
            <sentence id="5.2">I have checked with the debugger and the metadata are fine.</sentence>
            <sentence id="5.3">For the record, here's the metadata about this cached relations</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">Case 2: ClassCastException in StructuredMapCacheEntry,line 27</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">Map map = (Map) item;</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">where item is a CollectionCacheEntry array (empty in this case).</sentence>
            <sentence id="9.2">It relates to another relation that is working perfectly fine if cache replication is disabled</sentence>
        </paragraph>
    </description>
</bug>
