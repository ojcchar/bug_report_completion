<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-1813</id>
    <title>2nd level cached collections are locked causing a cache miss</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">Using the second level cache, collections are fetched from the database due to the cached item being locked.</sentence>
            <sentence id="1.2">This happens in the most simple use case:</sentence>
            <sentence id="1.3">1 Insert an entity with a collection</sentence>
            <sentence id="1.4">2 Commit.</sentence>
            <sentence id="1.5">3 Fetch the entity</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">I've written a simple test case and see the following in the log file:</sentence>
            <sentence id="2.16">domain.Cat.kittens [C/H/M/P]: 1/0/1/1</sentence>
            <sentence id="2.17">domain.Cat [C/H/M/P]: 1/0/0/1</sentence>
            <sentence id="2.18">domain.Kitten [C/H/M/P]: 1/0/0/1</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">This happens whether the collection is mapped as inverse or not.</sentence>
            <sentence id="3.2">I've attached the test case source and hbms (although it might need to be tweaked for the proper DB before running, and I didn't include the dependencies JARs).</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">Here's a code excerpt of the interesting part (tx is TransactionTemplate using HibnerateTransactionManager and hibernate is HibernateTemplate from the spring framework):</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">I can supply further information if needed.</sentence>
        </paragraph>
    </description>
</bug>
