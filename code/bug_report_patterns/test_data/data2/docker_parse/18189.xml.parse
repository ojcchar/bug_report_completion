<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>18189</id>
    <title>Port mapping behaviour differs between docker-machine and centos 7 - the mapped host port is open even though the container port is closed</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">## BUG REPORT INFORMATION</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">List the steps to reproduce the issue:</sentence>
            <sentence id="2.2">On OS X, using docker-machine 0.5.0 and docker 1.9.0:</sentence>
            <sentence id="2.3">"'
$ docker run -d -p 999:999 busybox sleep 100000
ecfb24ef7eed857548babb86974eb5444a72acdf777edb393effb61bf9cd5843</sentence>
            <sentence id="2.4">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
ecfb24ef7eed busybox "sleep 100000" 5 seconds ago Up 4 seconds 0.0.0.0:999-&gt;999/tcp sharp_kilby</sentence>
            <sentence id="2.5">$ nmap -A $(docker-machine ip default) -p 999
Starting Nmap 6.47 ( http://nmap.org ) at 2015-11-24 10:49 GMT
Nmap scan report for 192.168.99.100
Host is up (0.00037s latency).</sentence>
            <sentence id="2.6">PORT STATE SERVICE VERSION
999/tcp closed garcon
"'</sentence>
            <sentence id="2.7">On Centos 7, with docker 1.9.1:</sentence>
            <sentence id="2.8">"'
$ docker run -d -p 999:999 busybox sleep 100000
ea4f5982286c2a0a0c06687be94d3913020500f145c4e607e1c32938405f6a5d</sentence>
            <sentence id="2.9">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
ea4f5982286c busybox "sleep 100000" 3 seconds ago Up 2 seconds 0.0.0.0:999-&gt;999/tcp determined_roentgen</sentence>
            <sentence id="2.10">$ nmap -A localhost -p 999
Starting Nmap 6.40 ( http://nmap.org ) at 2015-11-24 10:52 GMT
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000038s latency).</sentence>
            <sentence id="2.11">Other addresses for localhost (not scanned): 127.0.0.1
PORT STATE SERVICE VERSION
999/tcp open tcpwrapped
"'</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">Describe the results you received:</sentence>
            <sentence id="3.2">- On centos 7, the mapped host port appears _open_ and you can connect to it.</sentence>
            <sentence id="3.3">You can also send data to it.</sentence>
            <sentence id="3.4">- On docker-machine on OS X has the mapped host port appears _closed_ and you cannot connect to it.</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">Describe the results you expected:</sentence>
            <sentence id="4.2">- On both platforms the port mapped on the host is closed, as the container port is closed/does not exist.</sentence>
            <sentence id="4.3">You cannot connect to the host port.</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">Provide additional info you think is important:</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">This is problematic for us as we are trying to wait for services to start from outside the docker container without knowing if they are http, https, other protocol etc.</sentence>
            <sentence id="6.2">It works fine with docker-machine, but with centos 7 we cannot simply try to connect to the socket, as it will connect.</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">Another problem is we get really odd errors when pinging these services if they aren't up; for example performing a HTTPS get will result in a SSLHandshakeException rather than a ConnectionRefused.</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">---</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">More OS X information:</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">"'
$ docker version
Client:
 Version: 1.9.0
 API version: 1.21
 Go version: go1.4.3
 Git commit: 76d6bc9
 Built: Tue Nov 3 19:20:09 UTC 2015
 OS/Arch: darwin/amd64</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">Server:
 Version: 1.9.0
 API version: 1.21
 Go version: go1.4.3
 Git commit: 76d6bc9
 Built: Tue Nov 3 19:20:09 UTC 2015
 OS/Arch: linux/amd64
"'</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">"'</sentence>
            <sentence id="12.2">$ docker info</sentence>
            <sentence id="12.3">Containers: 4</sentence>
            <sentence id="12.4">Images: 383</sentence>
            <sentence id="12.5">Server Version: 1.9.0</sentence>
            <sentence id="12.6">Storage Driver: aufs</sentence>
            <sentence id="12.7"> Root Dir: /mnt/sda1/var/lib/docker/aufs</sentence>
            <sentence id="12.8"> Backing Filesystem: extfs</sentence>
            <sentence id="12.9"> Dirs: 391</sentence>
            <sentence id="12.10"> Dirperm1 Supported: true</sentence>
            <sentence id="12.11">Execution Driver: native-0.2</sentence>
            <sentence id="12.12">Logging Driver: json-file</sentence>
            <sentence id="12.13">Kernel Version: 4.1.12-boot2docker</sentence>
            <sentence id="12.14">Operating System: Boot2Docker 1.9.0 (TCL 6.4); master : 16e4a2a - Tue Nov 3 19:49:22 UTC 2015</sentence>
            <sentence id="12.15">CPUs: 8</sentence>
            <sentence id="12.16">Total Memory: 3.858 GiB</sentence>
            <sentence id="12.17">Name: default</sentence>
            <sentence id="12.18">ID: YUGC:SSDN:BXRU:BNL7:KIYL:JNGI:H2MW:RJIW:BXDZ:VXVU:AKNQ:MMYZ</sentence>
            <sentence id="12.19">Debug mode (server): true</sentence>
            <sentence id="12.20"> File Descriptors: 30</sentence>
            <sentence id="12.21"> Goroutines: 56</sentence>
            <sentence id="12.22"> System Time: 2015-11-24T11:07:54.487607621Z</sentence>
            <sentence id="12.23"> EventsListeners: 0</sentence>
            <sentence id="12.24"> Init SHA1:</sentence>
            <sentence id="12.25"> Init Path: /usr/local/bin/docker</sentence>
            <sentence id="12.26"> Docker Root Dir: /mnt/sda1/var/lib/docker</sentence>
            <sentence id="12.27">Username: &lt;redacted&gt;</sentence>
            <sentence id="12.28">Registry: https://index.docker.io/v1/</sentence>
            <sentence id="12.29">Labels:</sentence>
            <sentence id="12.30"> provider=virtualbox</sentence>
            <sentence id="12.31">"'</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">"'
$ uname -a
Darwin &lt;redacted hostname&gt; 14.5.0 Darwin Kernel Version 14.5.0: Tue Sep 1 21:23:09 PDT 2015; root:xnu-2782.50.1~1/RELEASE_X86_64 x86_64
"'</sentence>
        </paragraph>
        <paragraph id="14">
            <sentence id="14.1">More Centos 7 infomation:</sentence>
        </paragraph>
        <paragraph id="15">
            <sentence id="15.1">"'
$ docker version
Client:
 Version: 1.9.1
 API version: 1.21
 Go version: go1.4.2
 Git commit: a34a1d5
 Built: Fri Nov 20 13:25:01 UTC 2015
 OS/Arch: linux/amd64</sentence>
        </paragraph>
        <paragraph id="16">
            <sentence id="16.1">Server:
 Version: 1.9.1
 API version: 1.21
 Go version: go1.4.2
 Git commit: a34a1d5
 Built: Fri Nov 20 13:25:01 UTC 2015
 OS/Arch: linux/amd64
"'</sentence>
        </paragraph>
        <paragraph id="17">
            <sentence id="17.1">"'</sentence>
            <sentence id="17.2">$ docker info</sentence>
            <sentence id="17.3">Containers: 9</sentence>
            <sentence id="17.4">Images: 26</sentence>
            <sentence id="17.5">Server Version: 1.9.1</sentence>
            <sentence id="17.6">Storage Driver: devicemapper</sentence>
            <sentence id="17.7"> Pool Name: docker-202:3-75497612-pool</sentence>
            <sentence id="17.8"> Pool Blocksize: 65.54 kB</sentence>
            <sentence id="17.9"> Base Device Size: 107.4 GB</sentence>
            <sentence id="17.10"> Backing Filesystem: xfs</sentence>
            <sentence id="17.11"> Data file: /dev/loop0</sentence>
            <sentence id="17.12"> Metadata file: /dev/loop1</sentence>
            <sentence id="17.13"> Data Space Used: 495.5 MB</sentence>
            <sentence id="17.14"> Data Space Total: 107.4 GB</sentence>
            <sentence id="17.15"> Data Space Available: 49.72 GB</sentence>
            <sentence id="17.16"> Metadata Space Used: 1.561 MB</sentence>
            <sentence id="17.17"> Metadata Space Total: 2.147 GB</sentence>
            <sentence id="17.18"> Metadata Space Available: 2.146 GB</sentence>
            <sentence id="17.19"> Udev Sync Supported: true</sentence>
            <sentence id="17.20"> Deferred Removal Enabled: false</sentence>
            <sentence id="17.21"> Deferred Deletion Enabled: false</sentence>
            <sentence id="17.22"> Deferred Deleted Device Count: 0</sentence>
            <sentence id="17.23"> Data loop file: /var/lib/docker/devicemapper/devicemapper/data</sentence>
            <sentence id="17.24"> Metadata loop file: /var/lib/docker/devicemapper/devicemapper/metadata</sentence>
            <sentence id="17.25"> Library Version: 1.02.93-RHEL7 (2015-01-28)</sentence>
            <sentence id="17.26">Execution Driver: native-0.2</sentence>
            <sentence id="17.27">Logging Driver: json-file</sentence>
            <sentence id="17.28">Kernel Version: 3.10.0-229.20.1.el7.x86_64</sentence>
            <sentence id="17.29">Operating System: CentOS Linux 7 (Core)</sentence>
            <sentence id="17.30">CPUs: 1</sentence>
            <sentence id="17.31">Total Memory: 992.1 MiB</sentence>
            <sentence id="17.32">Name: &lt;redacted hostname&gt;</sentence>
            <sentence id="17.33">ID: OME7:SHMY:75BZ:L74G:ZUIY:TMJX:3OC7:KSQG:X4WH:WGIZ:MES6:UWV4</sentence>
            <sentence id="17.34">"'</sentence>
        </paragraph>
        <paragraph id="18">
            <sentence id="18.1">"'
$ uname -a
Linux &lt;redacted hostname&gt; 3.10.0-229.20.1.el7.x86_64 #1 SMP Tue Nov 3 19:10:07 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
"'</sentence>
        </paragraph>
        <paragraph id="19">
            <sentence id="19.1">----------END REPORT ---------</sentence>
        </paragraph>
    </description>
</bug>
