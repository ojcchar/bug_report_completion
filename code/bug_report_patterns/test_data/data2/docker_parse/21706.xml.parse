<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>21706</id>
    <title>Cannot open more than 60 TCP connections from one container to another with docker networks</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">&lt;!</sentence>
            <sentence id="1.2">--
If you are reporting a new issue, make sure that we do not have any duplicates
already open.</sentence>
            <sentence id="1.3">You can ensure this by searching the issue list for this
repository.</sentence>
            <sentence id="1.4">If there is a duplicate, please close your issue and add a comment
to the existing issue instead.</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">If you suspect your issue is a bug, please edit your issue description to
include the BUG REPORT INFORMATION shown below.</sentence>
            <sentence id="2.2">If you fail to provide this
information within 7 days, we cannot debug your issue and will close it.</sentence>
            <sentence id="2.3">We
will, however, reopen it if you later provide the information.</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">For more information about reporting issues, see
https://github.com/docker/docker/blob/master/CONTRIBUTING.md#reporting-other-issues</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">---------------------------------------------------</sentence>
            <sentence id="4.2">BUG REPORT INFORMATION</sentence>
            <sentence id="4.3">---------------------------------------------------</sentence>
            <sentence id="4.4">Use the commands below to provide key information from your environment:</sentence>
            <sentence id="4.5">You do NOT have to include this information if this is a FEATURE REQUEST</sentence>
            <sentence id="4.6">--&gt;</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">**Output of 'docker version':**</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">"'
Client:
 Version: 1.10.2
 API version: 1.22
 Go version: go1.4.3
 Git commit: a34a1d59
 Built: 
 OS/Arch: linux/amd64</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">Server:
 Version: 1.10.2
 API version: 1.22
 Go version: go1.4.3
 Git commit: a34a1d59
 Built: 
 OS/Arch: linux/amd64
"'</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">**Output of 'docker info':**</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">"'</sentence>
            <sentence id="9.2">Containers: 120</sentence>
            <sentence id="9.3"> Running: 2</sentence>
            <sentence id="9.4"> Paused: 0</sentence>
            <sentence id="9.5"> Stopped: 118</sentence>
            <sentence id="9.6">Images: 290</sentence>
            <sentence id="9.7">Server Version: 1.10.2</sentence>
            <sentence id="9.8">Storage Driver: devicemapper</sentence>
            <sentence id="9.9"> Pool Name: docker-8:4-9187177-pool</sentence>
            <sentence id="9.10"> Pool Blocksize: 65.54 kB</sentence>
            <sentence id="9.11"> Base Device Size: 107.4 GB</sentence>
            <sentence id="9.12"> Backing Filesystem: ext4</sentence>
            <sentence id="9.13"> Data file: /dev/loop0</sentence>
            <sentence id="9.14"> Metadata file: /dev/loop1</sentence>
            <sentence id="9.15"> Data Space Used: 17.42 GB</sentence>
            <sentence id="9.16"> Data Space Total: 107.4 GB</sentence>
            <sentence id="9.17"> Data Space Available: 89.96 GB</sentence>
            <sentence id="9.18"> Metadata Space Used: 31.02 MB</sentence>
            <sentence id="9.19"> Metadata Space Total: 2.147 GB</sentence>
            <sentence id="9.20"> Metadata Space Available: 2.116 GB</sentence>
            <sentence id="9.21"> Udev Sync Supported: true</sentence>
            <sentence id="9.22"> Deferred Removal Enabled: false</sentence>
            <sentence id="9.23"> Deferred Deletion Enabled: false</sentence>
            <sentence id="9.24"> Deferred Deleted Device Count: 0</sentence>
            <sentence id="9.25"> Data loop file: /var/lib/docker/devicemapper/devicemapper/data</sentence>
            <sentence id="9.26"> WARNING: Usage of loopback devices is strongly discouraged for production use. Either use '--storage-opt dm.thinpooldev' or use '--storage-opt dm.no_warn_on_loop_devices=true' to suppress this warning.</sentence>
            <sentence id="9.27"> Metadata loop file: /var/lib/docker/devicemapper/devicemapper/metadata</sentence>
            <sentence id="9.28"> Library Version: 1.02.114 (2016-01-16)</sentence>
            <sentence id="9.29">Execution Driver: native-0.2</sentence>
            <sentence id="9.30">Logging Driver: json-file</sentence>
            <sentence id="9.31">Plugins: </sentence>
            <sentence id="9.32"> Volume: local</sentence>
            <sentence id="9.33"> Network: null host bridge</sentence>
            <sentence id="9.34">Kernel Version: 4.4.0</sentence>
            <sentence id="9.35">Operating System: NixOS 16.03pre75806.77f8f35 (Emu)</sentence>
            <sentence id="9.36">OSType: linux</sentence>
            <sentence id="9.37">Architecture: x86_64</sentence>
            <sentence id="9.38">CPUs: 8</sentence>
            <sentence id="9.39">Total Memory: 15.56 GiB</sentence>
            <sentence id="9.40">Name: rffnix</sentence>
            <sentence id="9.41">ID: 4FER:TIHU:3ZTT:EIGN:TW6P:DAJK:KPOX:ELI2:DXW6:NSFG:IYQU:J4J5</sentence>
            <sentence id="9.42">WARNING: No cpu cfs quota support</sentence>
            <sentence id="9.43">WARNING: No cpu cfs period support</sentence>
            <sentence id="9.44">"'</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">**Additional environment details (AWS, VirtualBox, physical, etc.):**</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">Using docker on linux</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">**Steps to reproduce the issue:**</sentence>
            <sentence id="12.2">1 Bring up a server container.</sentence>
            <sentence id="12.3">My tests were done with the zookeeper server container brought up via docker-compose with the following config snippet:</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">"'</sentence>
            <sentence id="13.2">version: "2"</sentence>
            <sentence id="13.3">services:</sentence>
            <sentence id="13.4">zookeeper:</sentence>
            <sentence id="13.5">image: netflixoss/exhibitor:1.5.2</sentence>
            <sentence id="13.6">ports:</sentence>
            <sentence id="13.7">- "2181:2181"</sentence>
            <sentence id="13.8">"'</sentence>
            <sentence id="13.9">1 Bring up a client container.</sentence>
            <sentence id="13.10">My tests were done with 'debian:latest':</sentence>
        </paragraph>
        <paragraph id="14">
            <sentence id="14.1">"'
docker run --net=env_default --rm -ti debian bash
"'</sentence>
        </paragraph>
        <paragraph id="15">
            <sentence id="15.1">I installed netcat inside the container via 'apt-get update ; apt-get -y install netcat net-tools'.</sentence>
            <sentence id="15.2">1 Open 59 connections to the server</sentence>
            <sentence id="15.3">I used a bash loop spawning 'nc' on the background, not exactly elegant, but did the job:</sentence>
        </paragraph>
        <paragraph id="16">
            <sentence id="16.1">"'</sentence>
            <sentence id="16.2"># for i in {1.</sentence>
            <sentence id="16.3">.59} ; do echo $i; nc zookeeper 2181 &amp; done</sentence>
            <sentence id="16.4">"'</sentence>
            <sentence id="16.5">1 Test that we successfully open a _60th_ ephemeral connection:</sentence>
        </paragraph>
        <paragraph id="17">
            <sentence id="17.1">"'</sentence>
            <sentence id="17.2"># echo ruok | nc zookeeper 2181</sentence>
            <sentence id="17.3">imok</sentence>
            <sentence id="17.4">"'</sentence>
            <sentence id="17.5">1 Open a new background connection to be the '60th'.</sentence>
        </paragraph>
        <paragraph id="18">
            <sentence id="18.1">"'</sentence>
            <sentence id="18.2"># nc zookeeper 2181 &amp;</sentence>
            <sentence id="18.3">"'</sentence>
            <sentence id="18.4">1 Check that further attempted connections do not succeed:</sentence>
        </paragraph>
        <paragraph id="19">
            <sentence id="19.1">"'
# echo ruok | nc zookeeper 2181
#
"'</sentence>
        </paragraph>
        <paragraph id="20">
            <sentence id="20.1">**Describe the results you received:**</sentence>
            <sentence id="20.2">The last attempt should have received an 'imok' reply according to Zookeeper's protocol, same as we saw on step _4_.</sentence>
            <sentence id="20.3">If count connections on the server container (with 'netstat -natp | wc -l') we can see this new attempt doesn't even register.</sentence>
        </paragraph>
        <paragraph id="21">
            <sentence id="21.1">**Describe the results you expected:**</sentence>
            <sentence id="21.2">The last attempt should have received an 'imok' reply.</sentence>
        </paragraph>
        <paragraph id="22">
            <sentence id="22.1">**Additional information you deem important (e.g. issue happens only occasionally):**</sentence>
            <sentence id="22.2">Output of _docker-compose -v_:</sentence>
        </paragraph>
        <paragraph id="23">
            <sentence id="23.1">"'
docker-compose -v
docker-compose version 1.6.2, build 4d72027
"'
</sentence>
        </paragraph>
    </description>
</bug>
