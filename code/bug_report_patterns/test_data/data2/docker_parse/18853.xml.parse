<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>18853</id>
    <title>--tmpfs fails with Permission denied and noexec is an invalid option</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">From https://github.com/rhatdan/docker/blob/b3e527dfd242ad30c0297c8b257862116cf2c50e/integration-cli/docker_cli_run_unix_test.go#L449: 
'dockerCmdWithError("run", "--tmpfs", "/run:noexec,nosuid,rw,size=5k,mode=700", "busybox", "touch", "/run/somefile"'</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">"' sh</sentence>
            <sentence id="2.2">$ docker run -ti -d --tmpfs /run:noexec,nosuid,rw,size=5k,mode=700 busybox touch /run/somefile</sentence>
            <sentence id="2.3">ab98b4ed8753270e95da880a912f021da7109a8e8e3ad42bb93fdfdd8d9d996f</sentence>
            <sentence id="2.4">$ docker run -ti -d --tmpfs /run:noexec busybox touch /run/somefile</sentence>
            <sentence id="2.5">docker: Invalid tmpfs option [""].</sentence>
            <sentence id="2.6">See 'docker run --help'.</sentence>
            <sentence id="2.7">$ docker run -ti -d --tmpfs /etc:noexec,nosuid,rw,size=5k,mode=700 busybox touch /tmp/somefile</sentence>
            <sentence id="2.8">75da9ade4b9dda3fb05ec915f440da38ce7e63b4d4e0796d4ca855fdfc38e158</sentence>
            <sentence id="2.9">docker: Error response from daemon: Cannot start container 75da9ade4b9dda3fb05ec915f440da38ce7e63b4d4e0796d4ca855fdfc38e158: [9] System error: configs.Command{Path:"/bin/tar", Args:[]string{"-cf", "/var/lib/docker/0.0/tmp/75da9ade4b9dda3fb05ec915f440da38ce7e63b4d4e0796d4ca855fdfc38e158018870457/_etc.tar", "-C", "/var/lib/docker/0.0/overlay/422b1cf19ddb33115ffa6de37784313271ae21ad474e7913652de234a705ef01/merged/etc", "."}, Env:[]string(nil), Dir:""} failed: /bin/tar: /var/lib/docker/0.0/overlay/422b1cf19ddb33115ffa6de37784313271ae21ad474e7913652de234a705ef01/merged/etc: Cannot open: Permission denied</sentence>
            <sentence id="2.10">/bin/tar: Error is not recoverable: exiting now</sentence>
            <sentence id="2.11">: exit status 2.</sentence>
            <sentence id="2.12">"'</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">"' sh
$ docker run --rm --tmpfs /etc:noexec busybox uname -a
docker: Invalid tmpfs option [""].
See 'docker run --help'.
"'</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">The logs below are generated with https://gist.github.com/konstruktoid/d5444c76cf502c795c29.</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">_:: Mount a tmpfs to verify basic tmpfs works_</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">"' sh
mount: none mounted on /tmp/tmpfstest.
none on /tmp/tmpfstest type tmpfs (rw,relatime,size=1048576k)
WORKS.
"'</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">_:: Create a testfile in the tmpfs_</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">"' sh</sentence>
            <sentence id="8.2">-rw------- 1 tsj tsj 29 Dec 22 18:02 /tmp/tmpfstest/pewpew</sentence>
            <sentence id="8.3">Tue Dec 22 17:02:41 UTC 2015</sentence>
            <sentence id="8.4">"'</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">_:: debian_::wheezy container uname*</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">"' sh
Linux 68afdf9c84ff 4.2.0-18-generic #22-Ubuntu SMP Fri Nov 6 18:25:50 UTC 2015 x86_64 GNU/Linux
WORKS.
"'</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">_:: debian_::wheezy container uname w readonly filesystem*</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">"' sh
Linux 1f58e9fa95eb 4.2.0-18-generic #22-Ubuntu SMP Fri Nov 6 18:25:50 UTC 2015 x86_64 GNU/Linux
WORKS.
"'</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">_:: debian_::wheezy container uname with --tmpfs /etc*</sentence>
        </paragraph>
        <paragraph id="14">
            <sentence id="14.1">"' sh
Timestamp: 2015-12-22 18:02:42.721797302 +0100 CET
Code: System error</sentence>
        </paragraph>
        <paragraph id="15">
            <sentence id="15.1">Message: configs.Command{Path:"/bin/tar", Args:[]string{"-cf", "/var/lib/docker/0.0/tmp/f66afbe8ccb867494bbcf746beda6325f6627823af1b660fe02b267a195e724a143435614/_etc.tar", "-C", "/var/lib/docker/0.0/overlay/4953cb98fc3b7f9512a9fbaacafc43068f18c32e8c70249e72b24a8d246de358/merged/etc", "."}</sentence>
            <sentence id="15.2">, Env:[]string(nil), Dir:""} failed: /bin/tar: /var/lib/docker/0.0/overlay/4953cb98fc3b7f9512a9fbaacafc43068f18c32e8c70249e72b24a8d246de358/merged/etc: Cannot open: Permission denied
/bin/tar: Error is not recoverable: exiting now
: exit status 2</sentence>
        </paragraph>
        <paragraph id="16">
            <sentence id="16.1">Frames:</sentence>
        </paragraph>
        <paragraph id="17">
            <sentence id="17.1">---</sentence>
            <sentence id="17.2">0: setupRootfs</sentence>
            <sentence id="17.3">Package: github.com/opencontainers/runc/libcontainer</sentence>
            <sentence id="17.4">File: rootfs_linux.go@36</sentence>
        </paragraph>
        <paragraph id="18">
            <sentence id="18.1">---</sentence>
            <sentence id="18.2">1: Init</sentence>
            <sentence id="18.3">Package: github.com/opencontainers/runc/libcontainer.</sentence>
            <sentence id="18.4">(*linuxStandardInit)</sentence>
            <sentence id="18.5">File: standard_init_linux.go@57</sentence>
        </paragraph>
        <paragraph id="19">
            <sentence id="19.1">---</sentence>
            <sentence id="19.2">2: StartInitialization</sentence>
            <sentence id="19.3">Package: github.com/opencontainers/runc/libcontainer.</sentence>
            <sentence id="19.4">(*LinuxFactory)</sentence>
            <sentence id="19.5">File: factory_linux.go@243</sentence>
        </paragraph>
        <paragraph id="20">
            <sentence id="20.1">---</sentence>
            <sentence id="20.2">3: initializer</sentence>
            <sentence id="20.3">Package: github.com/docker/docker/daemon/execdriver/native</sentence>
            <sentence id="20.4">File: init.go@35</sentence>
        </paragraph>
        <paragraph id="21">
            <sentence id="21.1">---</sentence>
            <sentence id="21.2">4: Init</sentence>
            <sentence id="21.3">Package: github.com/docker/docker/pkg/reexec</sentence>
            <sentence id="21.4">File: reexec.go@26</sentence>
        </paragraph>
        <paragraph id="22">
            <sentence id="22.1">---</sentence>
            <sentence id="22.2">5: main</sentence>
            <sentence id="22.3">Package: main</sentence>
            <sentence id="22.4">File: docker.go@18</sentence>
        </paragraph>
        <paragraph id="23">
            <sentence id="23.1">---</sentence>
            <sentence id="23.2">6: main</sentence>
            <sentence id="23.3">Package: runtime</sentence>
            <sentence id="23.4">File: proc.go@111</sentence>
        </paragraph>
        <paragraph id="24">
            <sentence id="24.1">---</sentence>
            <sentence id="24.2">7: goexit</sentence>
            <sentence id="24.3">Package: runtime</sentence>
            <sentence id="24.4">File: asm_amd64.s@1721</sentence>
            <sentence id="24.5">docker: Error response from daemon: Cannot start container f66afbe8ccb867494bbcf746beda6325f6627823af1b660fe02b267a195e724a: [9] System error: configs.Command{Path:"/bin/tar", Args:[]string{"-cf", "/var/lib/docker/0.0/tmp/f66afbe8ccb867494bbcf746beda6325f6627823af1b660fe02b267a195e724a143435614/_etc.tar", "-C", "/var/lib/docker/0.0/overlay/4953cb98fc3b7f9512a9fbaacafc43068f18c32e8c70249e72b24a8d246de358/merged/etc", "."}</sentence>
            <sentence id="24.6">, Env:[]string(nil), Dir:""} failed: /bin/tar: /var/lib/docker/0.0/overlay/4953cb98fc3b7f9512a9fbaacafc43068f18c32e8c70249e72b24a8d246de358/merged/etc: Cannot open: Permission denied</sentence>
            <sentence id="24.7">/bin/tar: Error is not recoverable: exiting now</sentence>
            <sentence id="24.8">: exit status 2.</sentence>
            <sentence id="24.9">"'</sentence>
        </paragraph>
        <paragraph id="25">
            <sentence id="25.1">_:: debian_::wheezy container uname with --tmpfs /etc:noexec*</sentence>
        </paragraph>
        <paragraph id="26">
            <sentence id="26.1">"' sh
docker: Invalid tmpfs option [""].
See 'docker run --help'.
"'</sentence>
        </paragraph>
        <paragraph id="27">
            <sentence id="27.1">_:: debian_::wheezy container uname with --tmpfs /etc:rw,nosuid using sudo*</sentence>
        </paragraph>
        <paragraph id="28">
            <sentence id="28.1">"' sh
docker: Invalid tmpfs option [""].
See 'docker run --help'.
"'</sentence>
        </paragraph>
        <paragraph id="29">
            <sentence id="29.1">_:: busybox touch /run/somefile (from tests)_
WORKS.</sentence>
        </paragraph>
        <paragraph id="30">
            <sentence id="30.1">_:: busybox fs options touch /run/somefile (from tests)_
WORKS.</sentence>
        </paragraph>
        <paragraph id="31">
            <sentence id="31.1">_:: busybox fs --tmpfs /etc_</sentence>
        </paragraph>
        <paragraph id="32">
            <sentence id="32.1">"' sh
Timestamp: 2015-12-22 18:02:44.308551924 +0100 CET
Code: System error</sentence>
        </paragraph>
        <paragraph id="33">
            <sentence id="33.1">Message: configs.Command{Path:"/bin/tar", Args:[]string{"-cf", "/var/lib/docker/0.0/tmp/b3d858cf619b1a5e649380c36613dd6f9a1cd99bc029b445cd96aa04d07a54d3087305069/_etc.tar", "-C", "/var/lib/docker/0.0/overlay/c0353ccf10594c403fcbb2d589b6c861171057c1a01015423d7dda30e657d8f8/merged/etc", "."}</sentence>
            <sentence id="33.2">, Env:[]string(nil), Dir:""} failed: /bin/tar: /var/lib/docker/0.0/overlay/c0353ccf10594c403fcbb2d589b6c861171057c1a01015423d7dda30e657d8f8/merged/etc: Cannot open: Permission denied
/bin/tar: Error is not recoverable: exiting now
: exit status 2</sentence>
        </paragraph>
        <paragraph id="34">
            <sentence id="34.1">Frames:</sentence>
        </paragraph>
        <paragraph id="35">
            <sentence id="35.1">---</sentence>
            <sentence id="35.2">0: setupRootfs</sentence>
            <sentence id="35.3">Package: github.com/opencontainers/runc/libcontainer</sentence>
            <sentence id="35.4">File: rootfs_linux.go@36</sentence>
        </paragraph>
        <paragraph id="36">
            <sentence id="36.1">---</sentence>
            <sentence id="36.2">1: Init</sentence>
            <sentence id="36.3">Package: github.com/opencontainers/runc/libcontainer.</sentence>
            <sentence id="36.4">(*linuxStandardInit)</sentence>
            <sentence id="36.5">File: standard_init_linux.go@57</sentence>
        </paragraph>
        <paragraph id="37">
            <sentence id="37.1">---</sentence>
            <sentence id="37.2">2: StartInitialization</sentence>
            <sentence id="37.3">Package: github.com/opencontainers/runc/libcontainer.</sentence>
            <sentence id="37.4">(*LinuxFactory)</sentence>
            <sentence id="37.5">File: factory_linux.go@243</sentence>
        </paragraph>
        <paragraph id="38">
            <sentence id="38.1">---</sentence>
            <sentence id="38.2">3: initializer</sentence>
            <sentence id="38.3">Package: github.com/docker/docker/daemon/execdriver/native</sentence>
            <sentence id="38.4">File: init.go@35</sentence>
        </paragraph>
        <paragraph id="39">
            <sentence id="39.1">---</sentence>
            <sentence id="39.2">4: Init</sentence>
            <sentence id="39.3">Package: github.com/docker/docker/pkg/reexec</sentence>
            <sentence id="39.4">File: reexec.go@26</sentence>
        </paragraph>
        <paragraph id="40">
            <sentence id="40.1">---</sentence>
            <sentence id="40.2">5: main</sentence>
            <sentence id="40.3">Package: main</sentence>
            <sentence id="40.4">File: docker.go@18</sentence>
        </paragraph>
        <paragraph id="41">
            <sentence id="41.1">---</sentence>
            <sentence id="41.2">6: main</sentence>
            <sentence id="41.3">Package: runtime</sentence>
            <sentence id="41.4">File: proc.go@111</sentence>
        </paragraph>
        <paragraph id="42">
            <sentence id="42.1">---</sentence>
            <sentence id="42.2">7: goexit</sentence>
            <sentence id="42.3">Package: runtime</sentence>
            <sentence id="42.4">File: asm_amd64.s@1721</sentence>
            <sentence id="42.5">docker: Error response from daemon: Cannot start container b3d858cf619b1a5e649380c36613dd6f9a1cd99bc029b445cd96aa04d07a54d3: [9] System error: configs.Command{Path:"/bin/tar", Args:[]string{"-cf", "/var/lib/docker/0.0/tmp/b3d858cf619b1a5e649380c36613dd6f9a1cd99bc029b445cd96aa04d07a54d3087305069/_etc.tar", "-C", "/var/lib/docker/0.0/overlay/c0353ccf10594c403fcbb2d589b6c861171057c1a01015423d7dda30e657d8f8/merged/etc", "."}</sentence>
            <sentence id="42.6">, Env:[]string(nil), Dir:""} failed: /bin/tar: /var/lib/docker/0.0/overlay/c0353ccf10594c403fcbb2d589b6c861171057c1a01015423d7dda30e657d8f8/merged/etc: Cannot open: Permission denied</sentence>
            <sentence id="42.7">/bin/tar: Error is not recoverable: exiting now</sentence>
            <sentence id="42.8">: exit status 2.</sentence>
            <sentence id="42.9">"'</sentence>
        </paragraph>
        <paragraph id="43">
            <sentence id="43.1">*:: busybox --tmpfs /etc:noexec</sentence>
        </paragraph>
        <paragraph id="44">
            <sentence id="44.1">"' sh
docker: Invalid tmpfs option [""].
See 'docker run --help'.
"'</sentence>
        </paragraph>
        <paragraph id="45">
            <sentence id="45.1">_:: Docker version_</sentence>
        </paragraph>
        <paragraph id="46">
            <sentence id="46.1">"' sh
Client:
 Version: 1.10.0-dev
 API version: 1.22
 Go version: go1.5.2
 Git commit: 8537501
 Built: Mon Dec 21 20:12:08 2015
 OS/Arch: linux/amd64
 Experimental: true</sentence>
        </paragraph>
        <paragraph id="47">
            <sentence id="47.1">Server:
 Version: 1.10.0-dev
 API version: 1.22
 Go version: go1.5.2
 Git commit: 8537501
 Built: Mon Dec 21 20:12:08 2015
 OS/Arch: linux/amd64
 Experimental: true
"'</sentence>
        </paragraph>
        <paragraph id="48">
            <sentence id="48.1">_:: Docker info_</sentence>
        </paragraph>
        <paragraph id="49">
            <sentence id="49.1">"' sh
Containers: 81
Images: 14
Server Version: 1.10.0-dev
Storage Driver: overlay
 Backing Filesystem: extfs
Execution Driver: native-0.2
Logging Driver: json-file
Plugins:
 Volume: local
 Network: bridge null host
Kernel Version: 4.2.0-18-generic
Operating System: Ubuntu 15.10
OSType: linux
Architecture: x86_64
CPUs: 1
Total Memory: 1.954 GiB
Name: lab01
ID: 6AEH:63II:LVVM:TZPI:LSSA:U5LL:U27O:XJ22:TBY6:6BKS:MTEX:PVEG
WARNING: No swap limit support
Experimental: true
"'</sentence>
        </paragraph>
        <paragraph id="50">
            <sentence id="50.1">_:: Docker group_
docker:x:999:tsj</sentence>
        </paragraph>
        <paragraph id="51">
            <sentence id="51.1">_:: Host information_
No LSB modules are available.</sentence>
            <sentence id="51.2">Distributor ID: Ubuntu
Description: Ubuntu 15.10
Release: 15.10
Codename: wily
Linux lab01 4.2.0-18-generic #22-Ubuntu SMP Fri Nov 6 18:25:50 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</sentence>
        </paragraph>
    </description>
</bug>
