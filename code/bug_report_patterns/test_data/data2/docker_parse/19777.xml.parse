<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>19777</id>
    <title>volume store dereference return without release lock</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">Description of problem:
The early return cause deadlock.</sentence>
            <sentence id="1.2">#dibs</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">"' go
func (s *VolumeStore) Dereference(v volume.Volume, ref string) {
 s.locks.Lock(v.Name())
 defer s.locks.Unlock(v.Name())</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">s.globalLock.Lock()
 refs, exists := s.refs[v.Name()]
 if !</sentence>
            <sentence id="3.2">exists {
 return
 }</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">for i, r := range refs {
 if r == ref {
 s.refs[v.Name()] = append(s.refs[v.Name()][:i], s.refs[v.Name()][i+1:]...)
 }
 }
 s.globalLock.Unlock()
}
"'</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">'docker version':</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">'docker info':</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">'uname -a':</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">Environment details (AWS, VirtualBox, physical, etc.):</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">How reproducible:</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">Steps to Reproduce:</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">Actual Results:</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">Expected Results:</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">Additional info:</sentence>
        </paragraph>
    </description>
</bug>
