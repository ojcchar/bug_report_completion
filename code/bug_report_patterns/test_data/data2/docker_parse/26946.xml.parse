<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>26946</id>
    <title>Connection to VIP fails exactly every other time</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">I've been using a three node cluster of bare-metal machines (packet) to test docker and different versions of MySQL.</sentence>
            <sentence id="1.2">After much frustration with networking "not working" I finally figured out the issue was with the VIP and I could consistently repeat the failed connection.</sentence>
            <sentence id="1.3">Here is my setup (may not be exactly same steps, since this all took place over several days):</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">Setup nodes: test1, test2, test3</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">"'</sentence>
            <sentence id="3.2">test1 # docker swarm init --advertise-addr bond0:0</sentence>
            <sentence id="3.3">test2 # docker swarm join --token SWMTKN-1-5ob... --advertise-addr bond0:0 test1:2377</sentence>
            <sentence id="3.4">test3 # docker swarm join --token SWMTKN-1-5ob... --advertise-addr bond0:0 test1:2377</sentence>
            <sentence id="3.5">test1 # docker node ls</sentence>
            <sentence id="3.6">ID HOSTNAME STATUS AVAILABILITY MANAGER STATUS</sentence>
            <sentence id="3.7">2lhelr6zmx9421j6b512pbd1v test3 Ready Active</sentence>
            <sentence id="3.8">4ymw90spyob7xmb5nqnzg3rch test2 Ready Active</sentence>
            <sentence id="3.9">b2oo4lplrbeiei5rw7kb4tuht 0_download_all_bugs.</sentence>
            <sentence id="3.10">sh 1_download_json.</sentence>
            <sentence id="3.11">sh data data2 log_download_1.</sentence>
            <sentence id="3.12">txt log_download_2.</sentence>
            <sentence id="3.13">txt log_download_3.</sentence>
            <sentence id="3.14">txt log_download_4.</sentence>
            <sentence id="3.15">txt nohup.out only_bugs.</sentence>
            <sentence id="3.16">csv pull_requests.</sentence>
            <sentence id="3.17">csv script2.sh test1 Ready Active Leader</sentence>
            <sentence id="3.18">test1 # docker network create --driver overlay mytest</sentence>
            <sentence id="3.19">test1 # docker service create --replicas 1 --constraint 'node.hostname==test2' --name mysql55 \</sentence>
            <sentence id="3.20">--network mytest -e MYSQL_ROOT_PASSWORD=pass mysql:5.5</sentence>
            <sentence id="3.21">test1 # docker service create --replicas 2 --constraint 'node.hostname!</sentence>
            <sentence id="3.22">=test2' --name php-fpm \</sentence>
            <sentence id="3.23">--network mytest php:fpm</sentence>
            <sentence id="3.24"># installed dnsutils and mysql-client packages in php-fpm containers for testing</sentence>
            <sentence id="3.25">"'</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">From test1 machine (which is swarm manager):</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">"'</sentence>
            <sentence id="5.2">test1 # docker exec -it php-fpm.2.... bash</sentence>
            <sentence id="5.3">-----------------------</sentence>
            <sentence id="5.4">root@363eac7aa037:/var/www# nslookup mysql55</sentence>
            <sentence id="5.5">Server: 127.0.0.11</sentence>
            <sentence id="5.6">Address: 127.0.0.11#53</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">Non-authoritative answer:
Name: mysql55
Address: 10.0.0.9
root@363eac7aa037:/var/www# mysql -h mysql55 -ppass -Be 'select 1'
1
1
root@363eac7aa037:/var/www# mysql -h mysql55 -ppass -Be 'select 1'
1
1
"'</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">From test3 machine:</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">"'</sentence>
            <sentence id="8.2">test3 # docker exec -it php-fpm.1.... bash</sentence>
            <sentence id="8.3">-----------------------</sentence>
            <sentence id="8.4">root@363eac7aa037:/var/www# nslookup mysql55</sentence>
            <sentence id="8.5">Server: 127.0.0.11</sentence>
            <sentence id="8.6">Address: 127.0.0.11#53</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">Non-authoritative answer:</sentence>
            <sentence id="9.2">Name: mysql55</sentence>
            <sentence id="9.3">Address: 10.0.0.9</sentence>
            <sentence id="9.4">root@156e32ec3853:/var/www# mysql -h mysql55 -ppass -Be 'select 1'</sentence>
            <sentence id="9.5">1</sentence>
            <sentence id="9.6">1</sentence>
            <sentence id="9.7">root@156e32ec3853:/var/www# mysql -h mysql55 -ppass -Be 'select 1'</sentence>
            <sentence id="9.8">ERROR 2003 (HY000): Can't connect to MySQL server on '10.0.0.9' (111)</sentence>
            <sentence id="9.9">root@156e32ec3853:/var/www# mysql -h mysql55 -ppass -Be 'select 1'</sentence>
            <sentence id="9.10">1</sentence>
            <sentence id="9.11">1</sentence>
            <sentence id="9.12">root@156e32ec3853:/var/www# mysql -h mysql55 -ppass -Be 'select 1'</sentence>
            <sentence id="9.13">ERROR 2003 (HY000): Can't connect to MySQL server on '10.0.0.9' (111)</sentence>
            <sentence id="9.14">root@156e32ec3853:/var/www# mysql -h 10.0.0.9 -ppass -Be 'select 1'</sentence>
            <sentence id="9.15">1</sentence>
            <sentence id="9.16">1</sentence>
            <sentence id="9.17">root@156e32ec3853:/var/www# mysql -h 10.0.0.9 -ppass -Be 'select 1'</sentence>
            <sentence id="9.18">ERROR 2003 (HY000): Can't connect to MySQL server on '10.0.0.9' (111)</sentence>
            <sentence id="9.19">root@156e32ec3853:/var/www# mysql -h 10.0.0.9 -ppass -Be 'select 1'</sentence>
            <sentence id="9.20">1</sentence>
            <sentence id="9.21">1</sentence>
            <sentence id="9.22">root@156e32ec3853:/var/www# mysql -h 10.0.0.9 -ppass -Be 'select 1'</sentence>
            <sentence id="9.23">ERROR 2003 (HY000): Can't connect to MySQL server on '10.0.0.9' (111)</sentence>
            <sentence id="9.24">root@156e32ec3853:/var/www# nslookup tasks.mysql55</sentence>
            <sentence id="9.25">Server: 127.0.0.11</sentence>
            <sentence id="9.26">Address: 127.0.0.11#53</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">Non-authoritative answer:
Name: tasks.mysql55
Address: 10.0.0.12
root@156e32ec3853:/var/www# mysql -h 10.0.0.12 -ppass -Be 'select 1'
1
1
root@156e32ec3853:/var/www# mysql -h 10.0.0.12 -ppass -Be 'select 1'
1
1
root@156e32ec3853:/var/www# mysql -h 10.0.0.12 -ppass -Be 'select 1'
1
1
"'</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">So the network connection fails every other time when using "mysql55" or "10.0.0.9" but it succeeds every time if using the container IP "10.0.0.12".</sentence>
            <sentence id="11.2">Result is the same using a php script with the php mysql client so it is not the mysql client binary.</sentence>
            <sentence id="11.3">DNS resolution is not the issue either as the same issue occurs when using the IP address so it is an issue with the VIP.</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">**Output of 'docker version':**</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">"'
~ # docker version
Client:
 Version: 1.12.1
 API version: 1.24
 Go version: go1.6.3
 Git commit: 23cf638
 Built: Thu Aug 18 05:33:38 2016
 OS/Arch: linux/amd64</sentence>
        </paragraph>
        <paragraph id="14">
            <sentence id="14.1">Server:
 Version: 1.12.1
 API version: 1.24
 Go version: go1.6.3
 Git commit: 23cf638
 Built: Thu Aug 18 05:33:38 2016
 OS/Arch: linux/amd64
"'</sentence>
        </paragraph>
        <paragraph id="15">
            <sentence id="15.1">**Output of 'docker info':**</sentence>
        </paragraph>
        <paragraph id="16">
            <sentence id="16.1">"'</sentence>
            <sentence id="16.2">~ # docker info</sentence>
            <sentence id="16.3">Containers: 27</sentence>
            <sentence id="16.4"> Running: 2</sentence>
            <sentence id="16.5"> Paused: 0</sentence>
            <sentence id="16.6"> Stopped: 25</sentence>
            <sentence id="16.7">Images: 16</sentence>
            <sentence id="16.8">Server Version: 1.12.1</sentence>
            <sentence id="16.9">Storage Driver: aufs</sentence>
            <sentence id="16.10"> Root Dir: /var/lib/docker/aufs</sentence>
            <sentence id="16.11"> Backing Filesystem: extfs</sentence>
            <sentence id="16.12"> Dirs: 154</sentence>
            <sentence id="16.13"> Dirperm1 Supported: true</sentence>
            <sentence id="16.14">Logging Driver: json-file</sentence>
            <sentence id="16.15">Cgroup Driver: cgroupfs</sentence>
            <sentence id="16.16">Plugins:</sentence>
            <sentence id="16.17"> Volume: local</sentence>
            <sentence id="16.18"> Network: host bridge null overlay</sentence>
            <sentence id="16.19">Swarm: active</sentence>
            <sentence id="16.20"> NodeID: b2oo4lplrbeiei5rw7kb4tuht</sentence>
            <sentence id="16.21"> Is Manager: true</sentence>
            <sentence id="16.22"> ClusterID: e23rayi2kifksru4ickovjy9r</sentence>
            <sentence id="16.23"> Managers: 1</sentence>
            <sentence id="16.24"> Nodes: 3</sentence>
            <sentence id="16.25"> Orchestration:</sentence>
            <sentence id="16.26"> Task History Retention Limit: 5</sentence>
            <sentence id="16.27"> Raft:</sentence>
            <sentence id="16.28"> Snapshot Interval: 10000</sentence>
            <sentence id="16.29"> Heartbeat Tick: 1</sentence>
            <sentence id="16.30"> Election Tick: 3</sentence>
            <sentence id="16.31"> Dispatcher:</sentence>
            <sentence id="16.32"> Heartbeat Period: 5 seconds</sentence>
            <sentence id="16.33"> CA Configuration:</sentence>
            <sentence id="16.34"> Expiry Duration: 3 months</sentence>
            <sentence id="16.35"> Node Address: 10.99.159.129</sentence>
            <sentence id="16.36">Runtimes: runc</sentence>
            <sentence id="16.37">Default Runtime: runc</sentence>
            <sentence id="16.38">Security Options: apparmor seccomp</sentence>
            <sentence id="16.39">Kernel Version: 4.2.0-36-generic</sentence>
            <sentence id="16.40">Operating System: Ubuntu 16.04.1 LTS</sentence>
            <sentence id="16.41">OSType: linux</sentence>
            <sentence id="16.42">Architecture: x86_64</sentence>
            <sentence id="16.43">CPUs: 4</sentence>
            <sentence id="16.44">Total Memory: 7.784 GiB</sentence>
            <sentence id="16.45">Name: test1</sentence>
            <sentence id="16.46">ID: GUJH:7NXP:OLTV:MADS:WGKO:24JC:7QU3:CAJW:YETD:YF4Y:EFRN:4YYQ</sentence>
            <sentence id="16.47">Docker Root Dir: /var/lib/docker</sentence>
            <sentence id="16.48">Debug Mode (client): false</sentence>
            <sentence id="16.49">Debug Mode (server): false</sentence>
            <sentence id="16.50">Username: bssllc</sentence>
            <sentence id="16.51">Registry: https://index.docker.io/v1/</sentence>
            <sentence id="16.52">WARNING: No swap limit support</sentence>
            <sentence id="16.53">Labels:</sentence>
            <sentence id="16.54"> provider=generic</sentence>
            <sentence id="16.55"> role=app</sentence>
            <sentence id="16.56"> specs=type0</sentence>
            <sentence id="16.57">Insecure Registries:</sentence>
            <sentence id="16.58"> 127.0.0.0/8</sentence>
            <sentence id="16.59">"'</sentence>
        </paragraph>
        <paragraph id="17">
            <sentence id="17.1">**Additional environment details (AWS, VirtualBox, physical, etc.):**</sentence>
            <sentence id="17.2">Bare-metal on packet.net.</sentence>
        </paragraph>
    </description>
</bug>
