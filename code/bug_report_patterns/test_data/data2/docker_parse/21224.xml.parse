<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>21224</id>
    <title>Docker network in internal mode will not use IPv4 by default and is very slow.</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">&lt;!</sentence>
            <sentence id="1.2">--
If you are reporting a new issue, make sure that we do not have any duplicates
already open.</sentence>
            <sentence id="1.3">You can ensure this by searching the issue list for this
repository.</sentence>
            <sentence id="1.4">If there is a duplicate, please close your issue and add a comment
to the existing issue instead.</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">If you suspect your issue is a bug, please edit your issue description to
include the BUG REPORT INFORMATION shown below.</sentence>
            <sentence id="2.2">If you fail to provide this
information within 7 days, we cannot debug your issue and will close it.</sentence>
            <sentence id="2.3">We
will, however, reopen it if you later provide the information.</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">For more information about reporting issues, see
https://github.com/docker/docker/blob/master/CONTRIBUTING.md#reporting-other-issues</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">---------------------------------------------------</sentence>
            <sentence id="4.2">BUG REPORT INFORMATION</sentence>
            <sentence id="4.3">---------------------------------------------------</sentence>
            <sentence id="4.4">Use the commands below to provide key information from your environment:</sentence>
            <sentence id="4.5">You do NOT have to include this information if this is a FEATURE REQUEST</sentence>
            <sentence id="4.6">--&gt;</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">**Output of 'docker version':**</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">"'
Client:
 Version: 1.11.0-dev
 API version: 1.23
 Go version: go1.6
 Git commit: 6f2d8b4
 Built: Tue Mar 15 17:55:34 2016
 OS/Arch: linux/amd64</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">Server:
 Version: 1.11.0-dev
 API version: 1.23
 Go version: go1.6
 Git commit: 6f2d8b4
 Built: Tue Mar 15 17:55:34 2016
 OS/Arch: linux/amd64
"'</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">**Output of 'docker info':**</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">"'</sentence>
            <sentence id="9.2">Containers: 8</sentence>
            <sentence id="9.3"> Running: 5</sentence>
            <sentence id="9.4"> Paused: 0</sentence>
            <sentence id="9.5"> Stopped: 3</sentence>
            <sentence id="9.6">Images: 1</sentence>
            <sentence id="9.7">Server Version: 1.11.0-dev</sentence>
            <sentence id="9.8">Storage Driver: aufs</sentence>
            <sentence id="9.9"> Root Dir: /var/lib/docker/aufs</sentence>
            <sentence id="9.10"> Backing Filesystem: extfs</sentence>
            <sentence id="9.11"> Dirs: 149</sentence>
            <sentence id="9.12"> Dirperm1 Supported: false</sentence>
            <sentence id="9.13">Execution Driver: native-0.2</sentence>
            <sentence id="9.14">Logging Driver: json-file</sentence>
            <sentence id="9.15">Cgroup Driver: cgroupfs</sentence>
            <sentence id="9.16">Plugins: </sentence>
            <sentence id="9.17"> Volume: local</sentence>
            <sentence id="9.18"> Network: bridge null host</sentence>
            <sentence id="9.19">Kernel Version: 3.13.0-74-generic</sentence>
            <sentence id="9.20">Operating System: Ubuntu 14.04.3 LTS</sentence>
            <sentence id="9.21">OSType: linux</sentence>
            <sentence id="9.22">Architecture: x86_64</sentence>
            <sentence id="9.23">CPUs: 1</sentence>
            <sentence id="9.24">Total Memory: 1.954 GiB</sentence>
            <sentence id="9.25">Name: ip-172-28-3-38</sentence>
            <sentence id="9.26">ID: OC3W:F5HD:OHOB:KRO2:2PF5:DFJZ:77D7:CVGC:QTKY:PCDW:H5LQ:WLYW</sentence>
            <sentence id="9.27">Docker Root Dir: /var/lib/docker</sentence>
            <sentence id="9.28">Debug mode (client): false</sentence>
            <sentence id="9.29">Debug mode (server): false</sentence>
            <sentence id="9.30">Registry: https://index.docker.io/v1/</sentence>
            <sentence id="9.31">WARNING: No swap limit support</sentence>
            <sentence id="9.32">"'</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">**Additional environment details (AWS, VirtualBox, physical, etc.):**</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">AWS EC2 instance.</sentence>
        </paragraph>
        <paragraph id="12">
            <sentence id="12.1">**Steps to reproduce the issue:**</sentence>
            <sentence id="12.2">1 Create a network in internal mode.</sentence>
            <sentence id="12.3">"'</sentence>
            <sentence id="12.4">docker network create --driver=bridge --internal internal</sentence>
            <sentence id="12.5">"'</sentence>
            <sentence id="12.6">1 Create two containers.</sentence>
            <sentence id="12.7">"'</sentence>
            <sentence id="12.8">docker run -d --net=internal --name=box1 busy box top</sentence>
            <sentence id="12.9">docker run -d --net=internal --name=box2 busybox top</sentence>
            <sentence id="12.10">"'</sentence>
            <sentence id="12.11">1 Invoke ping from one container to outside, and from one container to another container</sentence>
            <sentence id="12.12">"'
time docker exec box1 ping -c 1 www.google.com
ping: bad address 'www.google.com'</sentence>
            <sentence id="12.13">real 0m30.896s
user 0m0.034s
sys 0m0.013s</sentence>
            <sentence id="12.14">time docker exec box2 ping -c 1 box1
PING box1 (172.20.0.2): 56 data bytes
64 bytes from 172.20.0.2: seq=0 ttl=64 time=0.080 ms</sentence>
            <sentence id="12.15">--- box1 ping statistics ---</sentence>
            <sentence id="12.16">1 packets transmitted, 1 packets received, 0% packet loss</sentence>
            <sentence id="12.17">round-trip min/avg/max = 0.080/0.080/0.080 ms</sentence>
            <sentence id="12.18">real 0m15.886s</sentence>
            <sentence id="12.19">user 0m0.039s</sentence>
            <sentence id="12.20">sys 0m0.010s</sentence>
            <sentence id="12.21">"'</sentence>
            <sentence id="12.22">1 Invoke ping from one container to outside, and from one container to another container, (set IPv4 explicitly)</sentence>
            <sentence id="12.23">"'
time docker exec box1 ping -c 1 -4 www.google.com
ping: bad address 'www.google.com'</sentence>
            <sentence id="12.24">real 0m15.879s
user 0m0.038s
sys 0m0.010s</sentence>
            <sentence id="12.25">time docker exec box2 ping -c 1 -4 box1
PING box1 (172.20.0.2): 56 data bytes
64 bytes from 172.20.0.2: seq=0 ttl=64 time=0.054 ms</sentence>
            <sentence id="12.26">--- box1 ping statistics ---</sentence>
            <sentence id="12.27">1 packets transmitted, 1 packets received, 0% packet loss</sentence>
            <sentence id="12.28">round-trip min/avg/max = 0.054/0.054/0.054 ms</sentence>
            <sentence id="12.29">real 0m0.865s
user 0m0.038s
sys 0m0.013s
"'</sentence>
        </paragraph>
        <paragraph id="13">
            <sentence id="13.1">**Describe the results you received:**</sentence>
        </paragraph>
        <paragraph id="14">
            <sentence id="14.1">As is shown in the above, when a bridge network is created with option '--internal', a simple ping test is very slow unless IPv4 option ('-4') is specified explicitly.</sentence>
        </paragraph>
        <paragraph id="15">
            <sentence id="15.1">In addition, even if '-4' is specified, it takes a long time (15s) for a ping to return 
'ping: bad address 'www.google.com''.</sentence>
        </paragraph>
        <paragraph id="16">
            <sentence id="16.1">**Describe the results you expected:**</sentence>
            <sentence id="16.2">A simple ping test should return fairly quickly.</sentence>
        </paragraph>
        <paragraph id="17">
            <sentence id="17.1">**Additional information you deem important (e.g. issue happens only occasionally):**</sentence>
            <sentence id="17.2">See https://github.com/docker/docker/pull/21200 for reference.</sentence>
        </paragraph>
    </description>
</bug>
