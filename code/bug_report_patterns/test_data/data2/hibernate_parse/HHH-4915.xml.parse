<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-4915</id>
    <title>&lt;list-index&gt; base attribute ignored on insert for a bidirectional association (one-to-many)</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">My mapping looks like the following:
{code:xml}
&lt;hibernate-mapping&gt;</sentence>
            <sentence id="1.2">&lt;class name="Parent"&gt;</sentence>
            <sentence id="1.3">&lt;!-- SNIP --&gt;</sentence>
            <sentence id="1.4">&lt;list name="children" table="CHILD" cascade="all-delete-orphan"&gt;</sentence>
            <sentence id="1.5">&lt;key column="ID_PARENT" not-null="true" /&gt;</sentence>
            <sentence id="1.6">&lt;list-index base="1"&gt;</sentence>
            <sentence id="1.7">&lt;column name="IDX" check="IDX &gt; 0" /&gt;</sentence>
            <sentence id="1.8">&lt;/list-index&gt;</sentence>
            <sentence id="1.9">&lt;one-to-many class="Child" /&gt;</sentence>
            <sentence id="1.10">&lt;/list&gt;</sentence>
            <sentence id="1.11">&lt;/class&gt;
 
 &lt;class name="Child"&gt;</sentence>
            <sentence id="1.12">&lt;!-- SNIP --&gt;</sentence>
            <sentence id="1.13">&lt;many-to-one name="parent" class="Parent" column="ID_PARENT"</sentence>
            <sentence id="1.14">not-null="true" insert="false" update="false" /&gt;</sentence>
            <sentence id="1.15">&lt;/class&gt;</sentence>
            <sentence id="1.16">&lt;/hibernate-mapping&gt;</sentence>
            <sentence id="1.17">{code}</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">As you can see from the mapping, we have a parent entity ({{Parent}}) referring child entities ({{Child}} using the {{children}} accessor).</sentence>
            <sentence id="2.2">The index column ({{ORDER}}) is not an attribute in the child entity, so I referred to the second use case in section _6.3.3.</sentence>
            <sentence id="2.3">Bidirectional associations with indexed collections_ of the reference guide to do my mapping.</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">Everything works except for the index base, it is always 0 based on insert.</sentence>
            <sentence id="3.2">I've tried both Hibernate 3.3.2GA and the latest development version (3.5.0-CR-1), the issue can be reproduced in both.</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">I've joined a test case to reproduce the problem.</sentence>
            <sentence id="4.2">While working on it, I realized there are updates after the inserts setting the correct index.</sentence>
            <sentence id="4.3">However, we cannot change the database schema and there's a constraint on the index column enforcing a value &gt; 0.</sentence>
            <sentence id="4.4">So this issue is really important for us.</sentence>
            <sentence id="4.5">I could manually handle the index values, but it would be so much easier to let Hibernate do it.</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">I've traced the problem and it seems that {{StatefulPersistenceContext#getIndexInParent(..)}} does not considers the index base.</sentence>
            <sentence id="5.2">Why are updates necessary after the inserts?</sentence>
            <sentence id="5.3">It looks to me like Hibernate could correctly set the index parameter on the insert statements.</sentence>
        </paragraph>
    </description>
</bug>
