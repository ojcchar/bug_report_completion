<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-8581</id>
    <title>Batch update versioned with where clause generates bad SQL</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">Doing a batch update such as {{update versioned Animal set weight = 69 where weight = 0}} generates a SQLGrammarException.</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">{code}</sentence>
            <sentence id="2.2">org.hibernate.exception.SQLGrammarException: could not prepare statement</sentence>
            <sentence id="2.3">	at org.hibernate.exception.internal.SQLStateConversionDelegate.convert(SQLStateConversionDelegate.java:123)</sentence>
            <sentence id="2.4">	at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:49)</sentence>
            <sentence id="2.5">	at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:125)</sentence>
            <sentence id="2.6">	at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$StatementPreparationTemplate.prepareStatement(StatementPreparerImpl.java:188)</sentence>
            <sentence id="2.7">	at org.hibernate.engine.jdbc.internal.StatementPreparerImpl.prepareStatement(StatementPreparerImpl.java:91)</sentence>
            <sentence id="2.8">	at org.hibernate.hql.spi.TableBasedUpdateHandlerImpl.execute(TableBasedUpdateHandlerImpl.java:163)</sentence>
            <sentence id="2.9">	at org.hibernate.hql.internal.ast.exec.MultiTableUpdateExecutor.execute(MultiTableUpdateExecutor.java:65)</sentence>
            <sentence id="2.10">	at org.hibernate.hql.internal.ast.QueryTranslatorImpl.executeUpdate(QueryTranslatorImpl.java:415)</sentence>
            <sentence id="2.11">	at org.hibernate.engine.query.spi.HQLQueryPlan.performExecuteUpdate(HQLQueryPlan.java:282)</sentence>
            <sentence id="2.12">	at org.hibernate.internal.SessionImpl.executeUpdate(SessionImpl.java:1290)</sentence>
            <sentence id="2.13">	at org.hibernate.internal.QueryImpl.executeUpdate(QueryImpl.java:116)</sentence>
            <sentence id="2.14">	at org.hibernate.test.batch.joinedInheritence.BatchVersionedUpdateOfJoinedHierarchyTest.testUpdateVersionedWithWhereClause(BatchVersionedUpdateOfJoinedHierarchyTest.java:42)</sentence>
            <sentence id="2.15">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
            <sentence id="2.16">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</sentence>
            <sentence id="2.17">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</sentence>
            <sentence id="2.18">	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)</sentence>
            <sentence id="2.19">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)</sentence>
            <sentence id="2.20">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)</sentence>
            <sentence id="2.21">	at org.hibernate.testing.junit4.ExtendedFrameworkMethod.invokeExplosively(ExtendedFrameworkMethod.java:63)</sentence>
            <sentence id="2.22">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)</sentence>
            <sentence id="2.23">	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)</sentence>
            <sentence id="2.24">	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:30)</sentence>
            <sentence id="2.25">	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:62)</sentence>
            <sentence id="2.26">Caused by: org.h2.jdbc.JdbcSQLException: Table "ANIMAL0_" not found; SQL statement:</sentence>
            <sentence id="2.27">update Animal set animal0_.version=animal0_.version+1, weight=69 where (id) IN (select id from HT_Animal) [42102-145]</sentence>
            <sentence id="2.28">	at org.h2.message.DbException.getJdbcSQLException(DbException.java:327)</sentence>
            <sentence id="2.29">	at org.h2.message.DbException.get(DbException.java:167)</sentence>
            <sentence id="2.30">	at org.h2.message.DbException.get(DbException.java:144)</sentence>
            <sentence id="2.31">	at org.h2.command.Parser.readTableColumn(Parser.java:632)</sentence>
            <sentence id="2.32">	at org.h2.command.Parser.parseUpdate(Parser.java:664)</sentence>
            <sentence id="2.33">	at org.h2.command.Parser.parsePrepared(Parser.java:413)</sentence>
            <sentence id="2.34">	at org.h2.command.Parser.parse(Parser.java:274)</sentence>
            <sentence id="2.35">	at org.h2.command.Parser.parse(Parser.java:246)</sentence>
            <sentence id="2.36">	at org.h2.command.Parser.prepare(Parser.java:200)</sentence>
            <sentence id="2.37">	at org.h2.command.Parser.prepareCommand(Parser.java:213)</sentence>
            <sentence id="2.38">	at org.h2.engine.Session.prepareLocal(Session.java:423)</sentence>
            <sentence id="2.39">	at org.h2.engine.Session.prepareCommand(Session.java:373)</sentence>
            <sentence id="2.40">	at org.h2.jdbc.JdbcConnection.prepareCommand(JdbcConnection.java:1056)</sentence>
            <sentence id="2.41">	at org.h2.jdbc.JdbcPreparedStatement.&lt;init&gt;(JdbcPreparedStatement.java:71)</sentence>
            <sentence id="2.42">	at org.h2.jdbc.JdbcConnection.prepareStatement(JdbcConnection.java:233)</sentence>
            <sentence id="2.43">	at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$1.doPrepare(StatementPreparerImpl.java:98)</sentence>
            <sentence id="2.44">	at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$StatementPreparationTemplate.prepareStatement(StatementPreparerImpl.java:182)</sentence>
            <sentence id="2.45">	... 20 more</sentence>
            <sentence id="2.46">{code}</sentence>
        </paragraph>
    </description>
</bug>
