<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-217</id>
    <title>batch loading broken for many-to-one with property-ref</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">The current entity batch loading code assumes batch loading by identity (primary key).</sentence>
            <sentence id="1.2">Associations with property-ref do not resolve properly with batch loading turned on.</sentence>
            <sentence id="1.3">In H3 RC1:</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">ManyToOneType.java</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">private void scheduleBatchLoad(Serializable id, SessionImplementor session) 
	throws MappingException {
		
		EntityPersister persister = session.getFactory()
			.</sentence>
            <sentence id="3.2">getEntityPersister( getAssociatedEntityName() );
		
		session.getPersistenceContext()
			.</sentence>
            <sentence id="3.3">getBatchFetchQueue()
			.</sentence>
            <sentence id="3.4">addBatchLoadableEntityKey( new EntityKey( id, persister, session.getEntityMode() ) );
	}</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">Notice that EntityKey is always assumed, even when uniqueKeyPropertyName is set.</sentence>
            <sentence id="4.2">The code should take this into consideration and allow for batch loading by EntityUniqueKey.</sentence>
        </paragraph>
        <paragraph id="5">
            <sentence id="5.1">BatchFetchQueue.java</sentence>
        </paragraph>
        <paragraph id="6">
            <sentence id="6.1">public Serializable[] getEntityBatch(String entityName, Serializable id, int batchSize);</sentence>
        </paragraph>
        <paragraph id="7">
            <sentence id="7.1">public void addBatchLoadableEntityKey(EntityKey key);</sentence>
        </paragraph>
        <paragraph id="8">
            <sentence id="8.1">public void removeBatchLoadableEntityKey(EntityKey key);</sentence>
        </paragraph>
        <paragraph id="9">
            <sentence id="9.1">BatchingEntityLoader.java</sentence>
        </paragraph>
        <paragraph id="10">
            <sentence id="10.1">public Object load(Serializable id, Object optionalObject, SessionImplementor session)
	throws HibernateException;</sentence>
        </paragraph>
        <paragraph id="11">
            <sentence id="11.1">This code all makes the same assumptions.</sentence>
        </paragraph>
    </description>
</bug>
