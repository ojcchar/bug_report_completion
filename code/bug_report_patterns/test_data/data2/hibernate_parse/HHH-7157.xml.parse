<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
    <id>HHH-7157</id>
    <title>Bi-directional Many-to-One and One-to-Many mapping with EmbeddedId fails</title>
    <description>
        <paragraph id="1">
            <sentence id="1.1">Please see attached test cases on git: https://github.com/panghy/envers-embeddedid-test</sentence>
        </paragraph>
        <paragraph id="2">
            <sentence id="2.1">Hibernate tries to insert a parameter in the Audit table where there isn't one (6 parameter, trying to insert 7 and more).</sentence>
            <sentence id="2.2">The issue goes away if we add a @NotAudited annotation to the OneToMany side of the relation (commented out in the code).</sentence>
        </paragraph>
        <paragraph id="3">
            <sentence id="3.1">Hibernate: 
    insert 
    into
        PersonTuple_AUD
        (REVTYPE, helloWorld, personA_id, personB_id, constant_id, REV) 
    values
        (?</sentence>
            <sentence id="3.2">, ?</sentence>
            <sentence id="3.3">, ?</sentence>
            <sentence id="3.4">, ?</sentence>
            <sentence id="3.5">, ?</sentence>
            <sentence id="3.6">, ?)</sentence>
            <sentence id="3.7">Mar 8, 2012 2:11:39 AM org.hibernate.engine.jdbc.batch.internal.AbstractBatchImpl release
INFO: HHH000010: On release of batch it still contained JDBC statements</sentence>
        </paragraph>
        <paragraph id="4">
            <sentence id="4.1">javax.persistence.RollbackException: Error while committing the transaction</sentence>
            <sentence id="4.2">	at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:90)</sentence>
            <sentence id="4.3">	at org.hibernate.clementp.EnversTest.testAuditedEmbeddedId(EnversTest.java:55)</sentence>
            <sentence id="4.4">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
            <sentence id="4.5">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
            <sentence id="4.6">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</sentence>
            <sentence id="4.7">	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)</sentence>
            <sentence id="4.8">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)</sentence>
            <sentence id="4.9">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)</sentence>
            <sentence id="4.10">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)</sentence>
            <sentence id="4.11">	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)</sentence>
            <sentence id="4.12">	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)</sentence>
            <sentence id="4.13">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)</sentence>
            <sentence id="4.14">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:69)</sentence>
            <sentence id="4.15">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:48)</sentence>
            <sentence id="4.16">	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)</sentence>
            <sentence id="4.17">	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)</sentence>
            <sentence id="4.18">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)</sentence>
            <sentence id="4.19">	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)</sentence>
            <sentence id="4.20">	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)</sentence>
            <sentence id="4.21">	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)</sentence>
            <sentence id="4.22">	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)</sentence>
            <sentence id="4.23">	at org.junit.runners.ParentRunner.run(ParentRunner.java:292)</sentence>
            <sentence id="4.24">	at org.junit.runner.JUnitCore.run(JUnitCore.java:157)</sentence>
            <sentence id="4.25">	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:76)</sentence>
            <sentence id="4.26">	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:182)</sentence>
            <sentence id="4.27">	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:62)</sentence>
            <sentence id="4.28">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
            <sentence id="4.29">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
            <sentence id="4.30">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:120)</sentence>
            <sentence id="4.31">Caused by: javax.persistence.PersistenceException: org.hibernate.exception.GenericJDBCException: Invalid value "7" for parameter "parameterIndex" [90008-143]</sentence>
            <sentence id="4.32">	at org.hibernate.ejb.AbstractEntityManagerImpl.convert(AbstractEntityManagerImpl.java:1360)</sentence>
            <sentence id="4.33">	at org.hibernate.ejb.AbstractEntityManagerImpl.convert(AbstractEntityManagerImpl.java:1288)</sentence>
            <sentence id="4.34">	at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:78)</sentence>
            <sentence id="4.35">	... 31 more</sentence>
            <sentence id="4.36">Caused by: org.hibernate.exception.GenericJDBCException: Invalid value "7" for parameter "parameterIndex" [90008-143]</sentence>
            <sentence id="4.37">	at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:54)</sentence>
            <sentence id="4.38">	at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:125)</sentence>
            <sentence id="4.39">	at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:110)</sentence>
            <sentence id="4.40">	at org.hibernate.engine.jdbc.internal.proxy.AbstractStatementProxyHandler.continueInvocation(AbstractStatementProxyHandler.java:129)</sentence>
            <sentence id="4.41">	at org.hibernate.engine.jdbc.internal.proxy.AbstractProxyHandler.invoke(AbstractProxyHandler.java:81)</sentence>
            <sentence id="4.42">	at $Proxy22.setLong(Unknown Source)</sentence>
            <sentence id="4.43">	at org.hibernate.type.descriptor.sql.BigIntTypeDescriptor$1.doBind(BigIntTypeDescriptor.java:57)</sentence>
            <sentence id="4.44">	at org.hibernate.type.descriptor.sql.BasicBinder.bind(BasicBinder.java:92)</sentence>
            <sentence id="4.45">	at org.hibernate.type.AbstractStandardBasicType.nullSafeSet(AbstractStandardBasicType.java:305)</sentence>
            <sentence id="4.46">	at org.hibernate.type.AbstractStandardBasicType.nullSafeSet(AbstractStandardBasicType.java:300)</sentence>
            <sentence id="4.47">	at org.hibernate.type.ComponentType.nullSafeSet(ComponentType.java:358)</sentence>
            <sentence id="4.48">	at org.hibernate.persister.entity.AbstractEntityPersister.dehydrate(AbstractEntityPersister.java:2611)</sentence>
            <sentence id="4.49">	at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:2854)</sentence>
            <sentence id="4.50">	at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:3298)</sentence>
            <sentence id="4.51">	at org.hibernate.action.internal.EntityInsertAction.execute(EntityInsertAction.java:88)</sentence>
            <sentence id="4.52">	at org.hibernate.engine.spi.ActionQueue.execute(ActionQueue.java:362)</sentence>
            <sentence id="4.53">	at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:354)</sentence>
            <sentence id="4.54">	at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:275)</sentence>
            <sentence id="4.55">	at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:326)</sentence>
            <sentence id="4.56">	at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:52)</sentence>
            <sentence id="4.57">	at org.hibernate.internal.SessionImpl.flush(SessionImpl.java:1127)</sentence>
            <sentence id="4.58">	at org.hibernate.envers.synchronization.AuditProcess.doBeforeTransactionCompletion(AuditProcess.java:157)</sentence>
            <sentence id="4.59">	at org.hibernate.engine.spi.ActionQueue$BeforeTransactionCompletionProcessQueue.beforeTransactionCompletion(ActionQueue.java:662)</sentence>
            <sentence id="4.60">	at org.hibernate.engine.spi.ActionQueue.beforeTransactionCompletion(ActionQueue.java:307)</sentence>
            <sentence id="4.61">	at org.hibernate.internal.SessionImpl.beforeTransactionCompletion(SessionImpl.java:524)</sentence>
            <sentence id="4.62">	at org.hibernate.engine.transaction.internal.jdbc.JdbcTransaction.beforeTransactionCommit(JdbcTransaction.java:105)</sentence>
            <sentence id="4.63">	at org.hibernate.engine.transaction.spi.AbstractTransactionImpl.commit(AbstractTransactionImpl.java:175)</sentence>
            <sentence id="4.64">	at org.hibernate.ejb.TransactionImpl.commit(TransactionImpl.java:73)</sentence>
            <sentence id="4.65">	... 31 more</sentence>
            <sentence id="4.66">Caused by: org.h2.jdbc.JdbcSQLException: Invalid value "7" for parameter "parameterIndex" [90008-143]</sentence>
            <sentence id="4.67">	at org.h2.message.DbException.getJdbcSQLException(DbException.java:327)</sentence>
            <sentence id="4.68">	at org.h2.message.DbException.get(DbException.java:167)</sentence>
            <sentence id="4.69">	at org.h2.message.DbException.getInvalidValueException(DbException.java:213)</sentence>
            <sentence id="4.70">	at org.h2.jdbc.JdbcPreparedStatement.setParameter(JdbcPreparedStatement.java:1254)</sentence>
            <sentence id="4.71">	at org.h2.jdbc.JdbcPreparedStatement.setLong(JdbcPreparedStatement.java:541)</sentence>
            <sentence id="4.72">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
            <sentence id="4.73">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
            <sentence id="4.74">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</sentence>
            <sentence id="4.75">	at org.hibernate.engine.jdbc.internal.proxy.AbstractStatementProxyHandler.continueInvocation(AbstractStatementProxyHandler.java:122)</sentence>
            <sentence id="4.76">	... 55 more</sentence>
        </paragraph>
    </description>
</bug>
