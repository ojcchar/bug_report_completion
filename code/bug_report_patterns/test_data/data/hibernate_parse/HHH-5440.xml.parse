<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
	<id>HHH-5440</id>
	<title>Joined collection expressions not properly "rendered" in JPA Criteria queries</title>
	<description>
		<paragraph id="1">
			<sentence id="1.1">The situation is as follow:
I have an User class which has a collection of elements which is a Set of Role enum values and I want to search for users which have one of more roles.</sentence>
			<sentence id="1.2">I want to use the CriteriaBuilder, because I have a search form with a lot of fields which are optional.</sentence>
		</paragraph>
		<paragraph id="2">
			<sentence id="2.1">The User class:
@Entity
@Table(name = "USERS")
@Access(AccessType.FIELD)
public class User implements Serializable {</sentence>
		</paragraph>
		<paragraph id="3">
			<sentence id="3.1">@Id
 @GeneratedValue(strategy = GenerationType.AUTO)
 @Column(name = "ID")
 private Long id;</sentence>
		</paragraph>
		<paragraph id="4">
			<sentence id="4.1">@Column(name = "USERNAME", unique = true, nullable = false, length = 128)
 private String username;</sentence>
		</paragraph>
		<paragraph id="5">
			<sentence id="5.1">@ElementCollection
 @Enumerated(EnumType.STRING)
 @Column(name = "ROLE")
 @CollectionTable(name = "USER_ROLES", joinColumns = @JoinColumn(name = "USER_ID"))
 private Set&lt;Role&gt; roles = new HashSet&lt;Role&gt;();</sentence>
		</paragraph>
		<paragraph id="6">
			<sentence id="6.1">...
}</sentence>
		</paragraph>
		<paragraph id="7">
			<sentence id="7.1">The enum Role:
public enum Role {
 ROLE_1, ROLE_2, ROLE_3;
}</sentence>
		</paragraph>
		<paragraph id="8">
			<sentence id="8.1">Creating the query with the CriteriaBuilder
Set&lt;Role&gt; roles = new HashSet&lt;Role&gt;();
roles.add(Role.ROLE_1);
roles.add(Role.ROLE_2);</sentence>
		</paragraph>
		<paragraph id="9">
			<sentence id="9.1">CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
CriteriaQuery&lt;User&gt; criteriaQuery = criteriaBuilder.createQuery(User.class);</sentence>
		</paragraph>
		<paragraph id="10">
			<sentence id="10.1">Root&lt;User&gt; root = criteriaQuery.from(User.class);</sentence>
		</paragraph>
		<paragraph id="11">
			<sentence id="11.1">criteriaQuery.where(root.join("roles").</sentence>
			<sentence id="11.2">in(roles));</sentence>
		</paragraph>
		<paragraph id="12">
			<sentence id="12.1">TypedQuery&lt;User&gt; query = entityManager.createQuery(criteriaQuery);
query.getResultList();</sentence>
		</paragraph>
		<paragraph id="13">
			<sentence id="13.1">This is the exception:</sentence>
			<sentence id="13.2">java.lang.IllegalArgumentException: Parameter value [ROLE_2] was not matching type [java.util.Set]</sentence>
			<sentence id="13.3"> at org.hibernate.ejb.AbstractQueryImpl.registerParameterBinding(AbstractQueryImpl.java:360)</sentence>
			<sentence id="13.4"> at org.hibernate.ejb.QueryImpl.setParameter(QueryImpl.java:359)</sentence>
			<sentence id="13.5"> at org.hibernate.ejb.criteria.CriteriaQueryCompiler$1$1.bind(CriteriaQueryCompiler.java:194)</sentence>
			<sentence id="13.6"> at org.hibernate.ejb.criteria.CriteriaQueryCompiler.compile(CriteriaQueryCompiler.java:247)</sentence>
			<sentence id="13.7"> at org.hibernate.ejb.AbstractEntityManagerImpl.createQuery(AbstractEntityManagerImpl.java:437)</sentence>
			<sentence id="13.8">...</sentence>
		</paragraph>
		<paragraph id="14">
			<sentence id="14.1">This all works with OpenJPA 2.0.0</sentence>
		</paragraph>
	</description>
</bug>
