<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
	<id>7807</id>
	<title>Network problem when using a second eth interface that have a bloc IP on it. (config included)</title>
	<description>
		<paragraph id="1">
			<sentence id="1.1">Hello,</sentence>
		</paragraph>
		<paragraph id="2">
			<sentence id="2.1">One problem is that containers can't reach each other, when I ping from one to the other via the public ip redirected to them, it doesn't pass (see iptables problem below).</sentence>
		</paragraph>
		<paragraph id="3">
			<sentence id="3.1">The other problem is that every time I docker stop on a container, before I start it again I have to restart the whole docker (the daemon), if not, there is the port already binded error.</sentence>
			<sentence id="3.2">Even if I lsof, I don't see it bind, but docker think it is...</sentence>
		</paragraph>
		<paragraph id="4">
			<sentence id="4.1">Also if I want to access the container from outside, I have to delete nat rule within DOCKER statement in iptables -L -t nat.</sentence>
		</paragraph>
		<paragraph id="5">
			<sentence id="5.1">I have a bloc IP from OVH bind on eth1 of my server.</sentence>
			<sentence id="5.2">It has been a few weeks I run with that, I guess now I have to share it here so we can find how to solve the problem and stop the workarounds.</sentence>
			<sentence id="5.3">I only have one container that use the address on eth0, all the others is using an IP of the bloc on eth1.</sentence>
		</paragraph>
		<paragraph id="6">
			<sentence id="6.1">Kernel:
```
Linux 3.14-0.</sentence>
			<sentence id="6.2">bpo.1-amd64 #1 SMP Debian 3.14.12-1~bpo70+1 (2014-07-13) x86_64 GNU/Linux
```</sentence>
		</paragraph>
		<paragraph id="7">
			<sentence id="7.1">Docker:
```
Client version: 1.1.2
Client API version: 1.13
Go version (client): go1.2.1
Git commit (client): d84a070
Server version: 1.1.2
Server API version: 1.13
Go version (server): go1.2.1
Git commit (server): d84a070
```</sentence>
		</paragraph>
		<paragraph id="8">
			<sentence id="8.1">Here is my /etc/network/interfaces :
```
auto lo
iface lo inet loopback</sentence>
		</paragraph>
		<paragraph id="9">
			<sentence id="9.1">auto eth0
iface eth0 inet static
 address 38.58.18.236
 netmask 255.255.255.0
 network 38.58.18.0
 broadcast 38.58.18.255
 gateway 38.58.18.254</sentence>
		</paragraph>
		<paragraph id="10">
			<sentence id="10.1">iface eth0 inet6 static
 address 2001:41D0:8:65ec::
 netmask 64
 post-up /sbin/ip -f inet6 route add 2001:41D0:8:65ff:ff:ff:ff:ff dev eth0
 post-up /sbin/ip -f inet6 route add default via 2001:41D0:8:65ff:ff:ff:ff:ff
 pre-down /sbin/ip -f inet6 route del default via 2001:41D0:8:65ff:ff:ff:ff:ff
 pre-down /sbin/ip -f inet6 route del 2001:41D0:8:65ff:ff:ff:ff:ff dev eth0</sentence>
		</paragraph>
		<paragraph id="11">
			<sentence id="11.1">auto eth1</sentence>
			<sentence id="11.2">iface eth1 inet static</sentence>
			<sentence id="11.3"> address 38.58.252.224</sentence>
			<sentence id="11.4"> netmask 255.255.255.224</sentence>
			<sentence id="11.5"> post-up /sbin/ip route add default via 38.58.252.254 dev eth1 table 125</sentence>
			<sentence id="11.6"> post-up /sbin/ip rule add from 38.58.252.224/27 table 125</sentence>
			<sentence id="11.7"> pre-down /sbin/ip rule del from 38.58.252.224/27 table 125</sentence>
			<sentence id="11.8"> pre-down /sbin/ip route del default via 38.58.252.254 dev eth1 table 125</sentence>
			<sentence id="11.9"> post-up /sbin/ip addr add 38.58.252.225/27 dev eth1</sentence>
			<sentence id="11.10"> post-down /sbin/ip addr add 38.58.252.225/27 dev eth1</sentence>
			<sentence id="11.11"> post-up /sbin/ip addr add 38.58.252.226/27 dev eth1</sentence>
			<sentence id="11.12"> post-down /sbin/ip addr add 38.58.252.226/27 dev eth1</sentence>
			<sentence id="11.13"> post-up /sbin/ip addr add 38.58.252.227/27 dev eth1</sentence>
			<sentence id="11.14"> post-down /sbin/ip addr add 38.58.252.227/27 dev eth1</sentence>
			<sentence id="11.15"> post-up /sbin/ip addr add 38.58.252.228/27 dev eth1</sentence>
			<sentence id="11.16"> post-down /sbin/ip addr add 38.58.252.228/27 dev eth1</sentence>
			<sentence id="11.17">```</sentence>
			<sentence id="11.18">	 </sentence>
			<sentence id="11.19">Here is the ip addr:</sentence>
			<sentence id="11.20">```</sentence>
			<sentence id="11.21">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</sentence>
			<sentence id="11.22"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</sentence>
			<sentence id="11.23"> inet 127.0.0.1/8 scope host lo</sentence>
			<sentence id="11.24"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.25"> inet6 ::1/128 scope host</sentence>
			<sentence id="11.26"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.27">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</sentence>
			<sentence id="11.28"> link/ether 00:25:90:dd:32:0c brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.29"> inet 38.58.18.236/24 brd 38.58.18.255 scope global eth0</sentence>
			<sentence id="11.30"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.31"> inet6 2001:41d0:8:65ec::/64 scope global</sentence>
			<sentence id="11.32"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.33"> inet6 fe80::225:80ff:fedd:320c/64 scope link</sentence>
			<sentence id="11.34"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.35">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</sentence>
			<sentence id="11.36"> link/ether 00:25:90:dd:32:0d brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.37"> inet 38.58.252.225/27 scope global eth1</sentence>
			<sentence id="11.38"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.39"> inet 38.58.252.226/27 scope global secondary eth1</sentence>
			<sentence id="11.40"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.41"> inet 38.58.252.227/27 scope global secondary eth1</sentence>
			<sentence id="11.42"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.43"> inet 38.58.252.228/27 scope global secondary eth1</sentence>
			<sentence id="11.44"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.45"> inet 38.58.252.224/27 brd 38.58.252.255 scope global secondary eth1</sentence>
			<sentence id="11.46"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.47"> inet6 fe80::225:80ff:fedd:320d/64 scope link</sentence>
			<sentence id="11.48"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.49">267: veth49fb: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.50"> link/ether 52:3a:a2:ce:19:06 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.51"> inet6 fe80::503a:a2ff:fece:1906/64 scope link</sentence>
			<sentence id="11.52"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.53">277: veth9707: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.54"> link/ether 4e:19:2f:c7:26:db brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.55"> inet6 fe80::4c19:2fff:fec7:26db/64 scope link</sentence>
			<sentence id="11.56"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.57">53: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP</sentence>
			<sentence id="11.58"> link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.59"> inet 172.17.42.1/16 scope global docker0</sentence>
			<sentence id="11.60"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.61"> inet6 fe80::5484:7aff:fefe:9799/64 scope link</sentence>
			<sentence id="11.62"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.63">329: veth66fa: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.64"> link/ether d2:06:6c:c8:de:09 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.65"> inet6 fe80::d006:6cff:fec8:de09/64 scope link</sentence>
			<sentence id="11.66"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.67">185: veth652d: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.68"> link/ether 8a:f9:3a:e4:27:2e brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.69"> inet6 fe80::88f9:3aff:fee4:272e/64 scope link</sentence>
			<sentence id="11.70"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.71">191: veth3dbb: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.72"> link/ether f6:d2:d5:91:b2:d0 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.73"> inet6 fe80::f4d2:d5ff:fe91:b2d0/64 scope link</sentence>
			<sentence id="11.74"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.75">193: vethe287: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.76"> link/ether fe:42:2b:b5:eb:25 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.77"> inet6 fe80::fc42:2bff:feb5:eb25/64 scope link</sentence>
			<sentence id="11.78"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.79">207: veth9f71: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master docker0 state UP qlen 1000</sentence>
			<sentence id="11.80"> link/ether de:d5:4b:b9:0a:f1 brd ff:ff:ff:ff:ff:ff</sentence>
			<sentence id="11.81"> inet6 fe80::dcd5:4bff:feb9:af1/64 scope link</sentence>
			<sentence id="11.82"> valid_lft forever preferred_lft forever</sentence>
			<sentence id="11.83">```</sentence>
		</paragraph>
		<paragraph id="12">
			<sentence id="12.1">iptables -L -t nat :
```
Chain PREROUTING (policy ACCEPT)
target prot opt source destination
DOCKER all -- anywhere anywhere ADDRTYPE match dst-type LOCAL</sentence>
		</paragraph>
		<paragraph id="13">
			<sentence id="13.1">Chain INPUT (policy ACCEPT)
target prot opt source destination</sentence>
		</paragraph>
		<paragraph id="14">
			<sentence id="14.1">Chain OUTPUT (policy ACCEPT)
target prot opt source destination
DOCKER all -- anywhere !</sentence>
			<sentence id="14.2">loopback/8 ADDRTYPE match dst-type LOCAL</sentence>
		</paragraph>
		<paragraph id="15">
			<sentence id="15.1">Chain POSTROUTING (policy ACCEPT)
target prot opt source destination
MASQUERADE all -- 172.17.0.0/16 !</sentence>
			<sentence id="15.2">172.17.0.0/16</sentence>
		</paragraph>
		<paragraph id="16">
			<sentence id="16.1">Chain DOCKER (2 references)
target prot opt source destination
DNAT tcp -- anywhere alpha.xoib.com tcp dpt:63389 to:172.17.0.60:389
```</sentence>
		</paragraph>
		<paragraph id="17">
			<sentence id="17.1">I kept the last one because it is on the adress of eth0, the others for eth1 I had to delete them for the container to be reachable from outside</sentence>
		</paragraph>
		<paragraph id="18">
			<sentence id="18.1">I changed all the dns name and adresses to keep the server private.</sentence>
		</paragraph>
		<paragraph id="19">
			<sentence id="19.1">Thanks,</sentence>
		</paragraph>
	</description>
</bug>
