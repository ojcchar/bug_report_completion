<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
	<id>TRUNK-2813</id>
	<title>Missing max_occurs when saving visit attribute types should give a user friendly error message</title>
	<description>
		<paragraph id="1">
			<sentence id="1.1">When i try save a visit attribute type without supplying a max_occurs value, i get this error:</sentence>
		</paragraph>
		<paragraph id="2">
			<sentence id="2.1">An Internal Error has Occurred
org.hibernate.exception.ConstraintViolationException</sentence>
		</paragraph>
		<paragraph id="3">
			<sentence id="3.1">could not insert: [org.openmrs.VisitAttributeType]</sentence>
		</paragraph>
		<paragraph id="4">
			<sentence id="4.1">With the stack trace as below:</sentence>
		</paragraph>
		<paragraph id="5">
			<sentence id="5.1">{code}</sentence>
		</paragraph>
		<paragraph id="6">
			<sentence id="6.1">INFO - LoggingAdvice.invoke(117) |2011-10-28 13:25:12,953| In method VisitService.saveVisitAttributeType. Arguments: VisitAttributeType=org.openmrs.VisitAttributeType[c70b1daa-0c2a-4744-bd2e-0c56984e5888], </sentence>
			<sentence id="6.2">ERROR - JDBCExceptionReporter.logExceptions(78) |2011-10-28 13:25:12,988| Column 'max_occurs' cannot be null</sentence>
			<sentence id="6.3">ERROR - LoggingAdvice.invoke(126) |2011-10-28 13:25:12,989| An error occurred while executing this method. Error message: could not insert: [org.openmrs.VisitAttributeType]</sentence>
			<sentence id="6.4">org.hibernate.exception.ConstraintViolationException: could not insert: [org.openmrs.VisitAttributeType]</sentence>
			<sentence id="6.5">	at org.hibernate.exception.SQLStateConverter.convert(SQLStateConverter.java:71)</sentence>
			<sentence id="6.6">	at org.hibernate.exception.JDBCExceptionHelper.convert(JDBCExceptionHelper.java:43)</sentence>
			<sentence id="6.7">	at org.hibernate.id.insert.AbstractReturningDelegate.performInsert(AbstractReturningDelegate.java:40)</sentence>
			<sentence id="6.8">	at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:2158)</sentence>
			<sentence id="6.9">	at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:2638)</sentence>
			<sentence id="6.10">	at org.hibernate.action.EntityIdentityInsertAction.execute(EntityIdentityInsertAction.java:48)</sentence>
			<sentence id="6.11">	at org.hibernate.engine.ActionQueue.execute(ActionQueue.java:250)</sentence>
			<sentence id="6.12">	at org.hibernate.event.def.AbstractSaveEventListener.performSaveOrReplicate(AbstractSaveEventListener.java:298)</sentence>
			<sentence id="6.13">	at org.hibernate.event.def.AbstractSaveEventListener.performSave(AbstractSaveEventListener.java:181)</sentence>
			<sentence id="6.14">	at org.hibernate.event.def.AbstractSaveEventListener.saveWithGeneratedId(AbstractSaveEventListener.java:107)</sentence>
			<sentence id="6.15">	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.saveWithGeneratedOrRequestedId(DefaultSaveOrUpdateEventListener.java:187)</sentence>
			<sentence id="6.16">	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.entityIsTransient(DefaultSaveOrUpdateEventListener.java:172)</sentence>
			<sentence id="6.17">	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.performSaveOrUpdate(DefaultSaveOrUpdateEventListener.java:94)</sentence>
			<sentence id="6.18">	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.onSaveOrUpdate(DefaultSaveOrUpdateEventListener.java:70)</sentence>
			<sentence id="6.19">	at org.hibernate.impl.SessionImpl.fireSaveOrUpdate(SessionImpl.java:507)</sentence>
			<sentence id="6.20">	at org.hibernate.impl.SessionImpl.saveOrUpdate(SessionImpl.java:499)</sentence>
			<sentence id="6.21">	at org.hibernate.impl.SessionImpl.saveOrUpdate(SessionImpl.java:495)</sentence>
			<sentence id="6.22">	at org.openmrs.api.db.hibernate.HibernateVisitDAO.saveVisitAttributeType(HibernateVisitDAO.java:225)</sentence>
			<sentence id="6.23">	at org.openmrs.api.impl.VisitServiceImpl.saveVisitAttributeType(VisitServiceImpl.java:272)</sentence>
			<sentence id="6.24">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
			<sentence id="6.25">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
			<sentence id="6.26">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</sentence>
			<sentence id="6.27">	at java.lang.reflect.Method.invoke(Method.java:597)</sentence>
			<sentence id="6.28">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:309)</sentence>
			<sentence id="6.29">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:183)</sentence>
			<sentence id="6.30">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:150)</sentence>
			<sentence id="6.31">	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:110)</sentence>
			<sentence id="6.32">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.33">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:202)</sentence>
			<sentence id="6.34">	at $Proxy143.saveVisitAttributeType(Unknown Source)</sentence>
			<sentence id="6.35">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
			<sentence id="6.36">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
			<sentence id="6.37">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</sentence>
			<sentence id="6.38">	at java.lang.reflect.Method.invoke(Method.java:597)</sentence>
			<sentence id="6.39">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:309)</sentence>
			<sentence id="6.40">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:183)</sentence>
			<sentence id="6.41">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:150)</sentence>
			<sentence id="6.42">	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:110)</sentence>
			<sentence id="6.43">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.44">	at org.openmrs.aop.LoggingAdvice.invoke(LoggingAdvice.java:122)</sentence>
			<sentence id="6.45">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.46">	at org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(MethodBeforeAdviceInterceptor.java:50)</sentence>
			<sentence id="6.47">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.48">	at org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(MethodBeforeAdviceInterceptor.java:50)</sentence>
			<sentence id="6.49">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.50">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:202)</sentence>
			<sentence id="6.51">	at $Proxy144.saveVisitAttributeType(Unknown Source)</sentence>
			<sentence id="6.52">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</sentence>
			<sentence id="6.53">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</sentence>
			<sentence id="6.54">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</sentence>
			<sentence id="6.55">	at java.lang.reflect.Method.invoke(Method.java:597)</sentence>
			<sentence id="6.56">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:309)</sentence>
			<sentence id="6.57">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:183)</sentence>
			<sentence id="6.58">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:150)</sentence>
			<sentence id="6.59">	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:110)</sentence>
			<sentence id="6.60">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:172)</sentence>
			<sentence id="6.61">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:202)</sentence>
			<sentence id="6.62">	at $Proxy144.saveVisitAttributeType(Unknown Source)</sentence>
			<sentence id="6.63">	at org.openmrs.web.controller.visit.VisitAttributeTypeFormController.onSubmit(VisitAttributeTypeFormController.java:71)</sentence>
			<sentence id="6.64">	at org.springframework.web.servlet.mvc.SimpleFormController.processFormSubmission(SimpleFormController.java:272)</sentence>
			<sentence id="6.65">	at org.springframework.web.servlet.mvc.AbstractFormController.handleRequestInternal(AbstractFormController.java:268)</sentence>
			<sentence id="6.66">	at org.springframework.web.servlet.mvc.AbstractController.handleRequest(AbstractController.java:153)</sentence>
			<sentence id="6.67">	at org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter.handle(SimpleControllerHandlerAdapter.java:48)</sentence>
			<sentence id="6.68">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:790)</sentence>
			<sentence id="6.69">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:719)</sentence>
			<sentence id="6.70">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:644)</sentence>
			<sentence id="6.71">	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:560)</sentence>
			<sentence id="6.72">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:727)</sentence>
			<sentence id="6.73">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)</sentence>
			<sentence id="6.74">	at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:487)</sentence>
			<sentence id="6.75">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1093)</sentence>
			<sentence id="6.76">	at org.openmrs.module.web.filter.ForcePasswordChangeFilter.doFilter(ForcePasswordChangeFilter.java:65)</sentence>
			<sentence id="6.77">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.78">	at org.openmrs.module.web.filter.ModuleFilterChain.doFilter(ModuleFilterChain.java:76)</sentence>
			<sentence id="6.79">	at org.openmrs.module.xforms.web.XformsFilter.doFilter(XformsFilter.java:60)</sentence>
			<sentence id="6.80">	at org.openmrs.module.web.filter.ModuleFilterChain.doFilter(ModuleFilterChain.java:74)</sentence>
			<sentence id="6.81">	at org.openmrs.module.web.filter.ModuleFilter.doFilter(ModuleFilter.java:58)</sentence>
			<sentence id="6.82">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.83">	at org.openmrs.web.filter.OpenmrsFilter.doFilterInternal(OpenmrsFilter.java:111)</sentence>
			<sentence id="6.84">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)</sentence>
			<sentence id="6.85">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.86">	at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:198)</sentence>
			<sentence id="6.87">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)</sentence>
			<sentence id="6.88">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.89">	at org.openmrs.web.filter.StartupFilter.doFilter(StartupFilter.java:100)</sentence>
			<sentence id="6.90">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.91">	at org.openmrs.web.filter.StartupFilter.doFilter(StartupFilter.java:100)</sentence>
			<sentence id="6.92">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.93">	at org.openmrs.web.filter.StartupFilter.doFilter(StartupFilter.java:100)</sentence>
			<sentence id="6.94">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.95">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)</sentence>
			<sentence id="6.96">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)</sentence>
			<sentence id="6.97">	at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1084)</sentence>
			<sentence id="6.98">	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:360)</sentence>
			<sentence id="6.99">	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)</sentence>
			<sentence id="6.100">	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)</sentence>
			<sentence id="6.101">	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:726)</sentence>
			<sentence id="6.102">	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:405)</sentence>
			<sentence id="6.103">	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:206)</sentence>
			<sentence id="6.104">	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)</sentence>
			<sentence id="6.105">	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)</sentence>
			<sentence id="6.106">	at org.mortbay.jetty.Server.handle(Server.java:324)</sentence>
			<sentence id="6.107">	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:505)</sentence>
			<sentence id="6.108">	at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:843)</sentence>
			<sentence id="6.109">	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:648)</sentence>
			<sentence id="6.110">	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:211)</sentence>
			<sentence id="6.111">	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:380)</sentence>
			<sentence id="6.112">	at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:395)</sentence>
			<sentence id="6.113">	at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:488)</sentence>
			<sentence id="6.114">Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Column 'max_occurs' cannot be null</sentence>
			<sentence id="6.115">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</sentence>
			<sentence id="6.116">	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:39)</sentence>
			<sentence id="6.117">	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:27)</sentence>
			<sentence id="6.118">	at java.lang.reflect.Constructor.newInstance(Constructor.java:513)</sentence>
			<sentence id="6.119">	at com.mysql.jdbc.Util.handleNewInstance(Util.java:406)</sentence>
			<sentence id="6.120">	at com.mysql.jdbc.Util.getInstance(Util.java:381)</sentence>
			<sentence id="6.121">	at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1015)</sentence>
			<sentence id="6.122">	at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:956)</sentence>
			<sentence id="6.123">	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3536)</sentence>
			<sentence id="6.124">	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3468)</sentence>
			<sentence id="6.125">	at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:1957)</sentence>
			<sentence id="6.126">	at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2107)</sentence>
			<sentence id="6.127">	at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2648)</sentence>
			<sentence id="6.128">	at com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:2086)</sentence>
			<sentence id="6.129">	at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2371)</sentence>
			<sentence id="6.130">	at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2289)</sentence>
			<sentence id="6.131">	at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2274)</sentence>
			<sentence id="6.132">	at com.mchange.v2.c3p0.impl.NewProxyPreparedStatement.executeUpdate(NewProxyPreparedStatement.java:105)</sentence>
			<sentence id="6.133">	at org.hibernate.id.IdentityGenerator$GetGeneratedKeysDelegate.executeAndExtract(IdentityGenerator.java:73)</sentence>
			<sentence id="6.134">	at org.hibernate.id.insert.AbstractReturningDelegate.performInsert(AbstractReturningDelegate.java:33)</sentence>
			<sentence id="6.135">	... 106 more</sentence>
		</paragraph>
		<paragraph id="7">
			<sentence id="7.1">{code}</sentence>
		</paragraph>
	</description>
</bug>
