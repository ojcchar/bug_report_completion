<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bug>
	<id>TRUNK-594</id>
	<title>Exiting a patient from care causes "not-null property references a null or transient value: org.openmrs.PatientState.dateCreated"</title>
	<description>
		<paragraph id="1">
			<sentence id="1.1">This occurs when there's an actual state transition during the Exit Patient From Care use case.</sentence>
			<sentence id="1.2">The scenario is that the user selects an Exit Type that has a final state "trigger" associated with it.</sentence>
			<sentence id="1.3">When this occurs it causes the Exit From Care to actually perform a state transition, which simply pulls the "transition" state from the database and persist a new PatientState associated with this state.</sentence>
			<sentence id="1.4">The code then adds this new PatientState to the PatientProgram and saves the patient program, letting Hibernate cascade the save or update operation down through the dependent objects (TRAC-1063).</sentence>
			<sentence id="1.5">Since the cascade operation does not use (nor should it) the ProgramWorkflowService.savePatientProgram() method, we miss out on the null-checks for the metadata fields, which means Hiberante tries to persist the PatientState object with null values for some required fields. </sentence>
		</paragraph>
		<paragraph id="2">
			<sentence id="2.1">The quick workaround is to set the metadata fields in the instance of PatientState before adding it to and persisting the PatientProgram instance.</sentence>
			<sentence id="2.2">In the long run, the better approach would be to resolve ticket TRAC-1063.</sentence>
		</paragraph>
	</description>
</bug>
